<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TasteExplorer - ç¾å‘³æ¢ç´¢</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">
    <style>
        :root {
            --primary-orange: #FF6600;
            --glass-bg: rgba(25, 25, 25, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --label-color: #cccccc;
            --accent-yellow: #FFCC00;
        }
        html, body { overscroll-behavior-y: none; height: 100%; overflow: hidden; position: fixed; width: 100%; margin: 0; padding: 0; background-color: #000; }
        html { font-size: 14px; } 
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "SF Pro Text", "Helvetica Neue", sans-serif; }
        body { color: #fff; display: flex; align-items: center; justify-content: center; overscroll-behavior-x: none;}       
        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .bg-slide { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1s; }
        .bg-slide.active { opacity: 0.6; }
        /* API è¨­å®šç•«é¢ */
        #api-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%;background: rgba(0,0,0,0.5); backdrop-filter: blur(15px); z-index: 5000; display: none; align-items: center; justify-content: center;padding: 20px;}        
        .api-card {background: rgba(20, 20, 20, 0.95) !important;padding: 30px 25px 25px 25px !important;border-radius: 32px !important;border: 1px solid rgba(255, 255, 255, 0.08) !important;display: flex; flex-direction: column;width: 100%; max-width: 350px;max-height: 85vh; overflow-y: auto;gap: 15px;}        
        #api-guide-box {display: none;text-align: left;background: rgba(0, 0, 0, 0.4);border-radius: 20px;padding: 15px;margin: 5px 0 10px 0;border: 1px solid rgba(255, 255, 255, 0.05) !important;box-shadow: inset 0 0 20px rgba(0,0,0,0.5);}
        .guide-steps-container { display: flex; flex-direction: column; gap: 18px; }
        .step-item { display: flex; flex-direction: column; gap: 8px; }
        .step-title { font-size: 0.9rem; font-weight: 700; color: #eee; display: flex; align-items: center; gap: 10px; }
        .step-num { background: linear-gradient(135deg, var(--primary-orange), #FF8533); color: #fff; width: 22px; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 800; flex-shrink: 0; }
        .step-link-btn { display: block; text-align: center; background: rgba(255, 255, 255, 0.05); color: var(--accent-yellow); padding: 10px; border-radius: 12px; text-decoration: none; font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(255, 204, 0, 0.2); transition: 0.3s; }
        .step-link-btn:hover { background: rgba(255, 204, 0, 0.1); border-color: var(--accent-yellow); }
        .api-tag-container { display: flex; gap: 10px; margin-top: 5px; }
        .api-tag { flex: 1; background: rgba(255, 255, 255, 0.03); padding: 12px 8px; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.05); }
        .api-tag-name { display: block; color: var(--accent-yellow); font-size: 0.75rem; font-weight: 800; margin-bottom: 4px; }
        .api-tag-desc { display: block; color: #888; font-size: 0.65rem; }
        .api-input { width: 100%; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; color: white; font-size: 1rem; text-align: center; }
        .api-save-btn { width: 100%; background: linear-gradient(135deg, #FF8533, #FF6600); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(255, 102, 0, 0.2); }
        #toggle-guide-btn { background: rgba(255, 204, 0, 0.1); border: 1px solid var(--accent-yellow); color: var(--accent-yellow); padding: 10px; border-radius: 10px; font-size: 0.85rem; cursor: pointer; }

        /* ä¸» UI ä½ˆå±€ */
        .container { width: 95%; max-width: 357px; height: 100dvh; z-index: 10; display: flex; flex-direction: column; justify-content: space-evenly; align-items: center; padding: 10px 0; position: relative; transition: 0.3s; }
        .container.blur-mode { filter: blur(15px) brightness(0.4); transform: scale(0.95); pointer-events: none; }
        .logo { font-size: 2.77rem; font-weight: 800; color: var(--primary-orange); line-height: 1.1; letter-spacing: -1px; margin: 0; }
        .tagline {font-size: 1.2rem;color: #ffffff;opacity: 0.8;margin-top: 6px;text-align: center;width: 100%;display: block;}        
        .settings-btn { position: absolute; top: 0; right: 0; height: 3rem; display: flex; align-items: center; font-size: 24px; cursor: pointer; z-index: 50; padding: 0 5px; }
        .glass-card { width: 100%; background: rgba(20, 20, 20, 0.75); backdrop-filter: blur(20px); border-radius: 24px; padding: 18px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 12px; }
        .location-status { width: 100%; font-size: 0.8rem; background: var(--input-bg); padding: 10px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.3s; }
        .location-status.active-mode { background: rgba(255, 204, 0, 0.15) !important; color: var(--accent-yellow) !important; border-color: rgba(255, 204, 0, 0.4); box-shadow: 0 0 15px rgba(255, 204, 0, 0.1); }
        .location-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: pulse 2s infinite; }
        .info-bar { display: flex; flex-direction: row; flex-wrap: wrap; gap: 10px; margin: 5px 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 2; }
        label { font-size: 0.75rem; color: #ffffff; margin-bottom: 4px; display: block; font-weight: 600; }
        .input-box { background: var(--input-bg); border-radius: 10px; height: 38px; display: flex; align-items: center; padding: 0 10px; border: 1px solid transparent; transition: 0.3s; }
        select { background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 0.85rem; appearance: none; }
        .toggle-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px; }
        .toggle-btn { background: var(--input-bg); height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid transparent; font-size: 0.85rem; transition: 0.3s; }
        .toggle-btn.selected { background: rgba(255,102,0,0.2); border-color: var(--primary-orange); color: var(--primary-orange); font-weight: bold; }
        #btn-open.selected { background: rgba(46,204,113,0.15); border-color: #2ecc71; color: #2ecc71; }
        .footer-action { width: 100%; flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; }
        .cta-button { width: 100%; background: linear-gradient(180deg, #FF8533, #FF6600); border: none; padding: 16px; font-weight: 700; border-radius: 16px; color: #fff; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 102, 0, 0.4); transition: 0.3s; }
        .usage-hint { font-size: 0.85rem; opacity: 0.7; color: #ffffff; font-weight: 500; flex: 0 0 auto; margin-top: 8px; }
        .hide-field { display: none !important; }
        #loader {display: none;position: fixed;top: 0; left: 0;width: 100vw; height: 100vh;z-index: 10000;background: rgba(0, 0, 0, 0.7);backdrop-filter: blur(20px) saturate(160%);flex-direction: column; align-items: center; justify-content: center;}
        .resonance-container {position: relative;width: 200px; height: 200px;display: flex; align-items: center; justify-content: center;}
        .core-dot {width: 12px; height: 12px;background: var(--primary-orange);border-radius: 50%;box-shadow: 0 0 30px var(--primary-orange);animation: core-breath 2s ease-in-out infinite;z-index: 10;}
        .resonance-wave {position: absolute;border: 1.5px solid var(--primary-orange);border-radius: 50%;opacity: 0;animation: wave-expand 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;}
        .resonance-wave:nth-child(2) { animation-delay: 0.8s; }
        .resonance-wave:nth-child(3) { animation-delay: 1.6s; }
        @keyframes core-breath {0%, 100% { transform: scale(1); opacity: 0.8; }50% { transform: scale(1.4); opacity: 1; box-shadow: 0 0 45px var(--primary-orange); }}
        @keyframes wave-expand {0% { width: 10px; height: 10px; opacity: 0; transform: scale(1); }10% { opacity: 0.5; }100% { width: 220px; height: 220px; opacity: 0; transform: scale(1.1); border-width: 0.5px; }}
        .loader-text {margin-top: 50px;color: #fff;font-size: 1.15rem;font-weight: 600;letter-spacing: 2px;text-align: center;min-height: 1.5em;border-right: 3px solid var(--primary-orange);padding-right: 8px;white-space: nowrap;overflow: hidden;animation: cursor-blink 0.8s infinite;}
        @keyframes cursor-blink {0%, 100% { border-color: transparent; }50% { border-color: var(--primary-orange); }}
        /* --- å¡ç‰‡ç–ŠåŠ èˆ‡æ»‘å‹•ç³»çµ±ç³»çµ± (é«˜è³ªæ„ŸåŸç‰ˆ) --- */
        #swiper-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; flex-direction: column; align-items: center; background: radial-gradient(circle at center, rgba(30, 40, 50, 0.6) 0%, rgba(10, 15, 20, 0.85) 100%);backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); overflow-y: auto; }
        .card-stack { width: 100%; max-width: 360px; padding: 30px 0 50px 0; display: flex; flex-direction: column; align-items: center; gap: 25px; }
        .swipe-card-wrapper { width: 92%; flex-shrink: 0; position: relative; transition: transform 0.4s ease, opacity 0.4s ease; touch-action: pan-y; }
        .swipe-card { width: 100%; background: rgba(255, 255, 255, 0.08); border-radius: 32px; border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 20px 40px rgba(0,0,0,0.4);display: flex; flex-direction: column; position: relative; overflow: hidden; height: auto;}
        .card-content { padding: 40px 25px 30px 25px;}
        .card-title { font-size: 1.7rem; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-weight: 800; margin: 0; line-height: 1.2; }
        .detail-row {font-size: 0.85rem;color: #ccc;line-height: 1.5;margin-bottom: 6px;}        
        .summary-quote { font-style: italic; color: #cecece; background: rgba(255, 255, 255, 0.06) !important; border: none !important; padding: 16px 20px; border-radius: 18px;margin: 15px 0; font-size: 0.9rem; line-height: 1.6;}
        .card-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; display: inline-block; margin-right: 5px; }
        .badge-rating { background: var(--accent-yellow); color: #000; }
        .badge-distance { background: var(--primary-orange); color: #fff; }
        .badge-price { background: rgba(255,255,255,0.1); color: #eee; }
        .card-map-btn {display: flex;align-items: center;justify-content: center;width: 100%;height: 54px;background: var(--primary-orange);color: #fff;text-decoration: none;border-radius: 16px;font-weight: bold;font-size: 1rem;margin-top: 15px;       box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);transition: 0.3s;}
        .card-map-btn:active {transform: scale(0.98);filter: brightness(0.9);}
        .swipe-hints { position: absolute; top: 12px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 15px; pointer-events: none; z-index: 5; }
        .hint-item { font-size: 0.65rem; font-weight: bold; color: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .swipe-label { position: absolute; top: 40px;padding: 5px 15px; border: 4px solid; border-radius: 12px; font-size: 2.2rem; font-weight: 900; text-transform: uppercase; opacity: 0; pointer-events: none; z-index: 110; }
        .label-like { left: 25px; right: auto; color: #2ecc71; border-color: #2ecc71; transform: rotate(-15deg); /* æ”¹ç‚ºå‘å·¦æ­ª */text-shadow: 0 0 10px rgba(46,204,113,0.5); }       
        .label-nope { right: 25px; left: auto; color: #e74c3c; border-color: #e74c3c; transform: rotate(15deg); /* æ”¹ç‚ºå‘å³æ­ª */text-shadow: 0 0 10px rgba(231,76,60,0.5); }
        .label-chosen { position: absolute; top: 20px; left: 20px; padding: 5px 15px; border: 4px solid #2ecc71; color: #2ecc71; border-radius: 10px; font-size: 1.8rem; font-weight: 900; opacity: 0; pointer-events: none; z-index: 20; transform: scale(5); transition: all 0.4s; background: rgba(0,0,0,0.3); }
        .label-chosen.active { opacity: 1; transform: scale(1) rotate(-15deg); }
        .close-swiper { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px 40px; border-radius: 50px; cursor: pointer; font-weight: bold; backdrop-filter: blur(10px); margin: 20px 0 40px 0; flex-shrink: 0; }
        .card-title { font-size: 1.8rem; font-weight: 900; color: #fff; line-height: 1.2; margin: 0;}        
        .card-meta-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;}
        .meta-item {background: rgba(255, 255, 255, 0.05);padding: 8px 10px; border-radius: 10px;font-size: 0.75rem; font-weight: 600;display: flex; align-items: center; gap: 6px;color: #eee; border: 1px solid rgba(255,255,255,0.05);}
        .meta-item i { color: var(--accent-yellow); font-style: normal; }
        .meta-price { color: var(--accent-yellow); border-color: rgba(255, 204, 0, 0.2); }
        .meta-dist { background: rgba(255, 102, 0, 0.1); color: var(--primary-orange); }
        .info-section { margin-bottom: 12px; }
        .info-label { color: var(--primary-orange); font-weight: 800; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 2px; display: block; letter-spacing: 1px; }
        .info-text { color: #ccc; font-size: 0.85rem; line-height: 1.4; }
        .card-summary-box {background: rgba(255, 102, 0, 0.05);border-left: 3px solid var(--primary-orange);padding: 10px 12px; border-radius: 0 12px 12px 0;font-size: 0.88rem; font-style: italic; color: #ddd; margin: 15px 0;}
        .swipe-label { z-index: 100 !important; }
        .card-content { padding: 45px 25px 35px 25px; /* é ‚éƒ¨ç•™ç™½å¢åŠ å‘¼å¸æ„Ÿ */display: flex; flex-direction: column; gap: 22px;}
        .pill { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 800; display: inline-flex; align-items: center; justify-content: center;}
        .pill-time { background: rgba(255, 255, 255, 0.05);color: #bbb;}
        .pill-orange { background: #FF6600 !important; color: #fff !important; padding: 6px 12px; border-radius: 8px; font-weight: 800; display: inline-flex;align-items: center;}      
        .pill-yellow { background: #FFCC00 !important; color: #000 !important; padding: 6px 12px; border-radius: 8px;font-weight: 800; display: inline-flex;align-items: center;}        
        .pill-price { background: rgba(255, 255, 255, 0.05) !important; border: 1.5px solid rgba(255, 255, 255, 0.2) !important; /* æ ¸å¿ƒï¼šæ·±è‰²å¸¶é‚Šæ¡† */color: #eee !important; padding: 6px 12px; border-radius: 8px; /* åœ“è§’æ–¹å¡Šæ„Ÿ */font-weight: 800; display: inline-flex;align-items: center;}      
        .detail-section { display: flex; flex-direction: column; gap: 6px; }
        .detail-label { color: var(--primary-orange); font-weight: 800; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .detail-text { color: #ddd; font-size: 0.95rem; line-height: 1.6; }
        .detail-row { margin-bottom: 25px; } /* å¢åŠ æ®µè½é–“éš” */
        .summary-quote { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; font-style: italic; color: #bbb; border-left: 3px solid var(--primary-orange); margin: 5px 0;}
        #no-match-modal {display: none;flex-direction: column;align-items: center;justify-content: center;width: 85%;max-width: 320px; background: rgba(255, 255, 255, 0.1);backdrop-filter: blur(30px);border: 1px solid rgba(255, 255, 255, 0.2);border-radius: 32px;padding: 40px 20px;text-align: center;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 500;}
        .modal-retry-btn {background: linear-gradient(135deg, #FF8533, #FF6600);color: white;border: none;padding: 15px 40px;border-radius: 50px;font-weight: bold;font-size: 1rem;cursor: pointer;margin-top: 20px;}
        .hide-field { display: none !important; }

        .menu-item {display: flex;align-items: center;gap: 15px;padding: 15px;border-radius: 12px;color: #eee;font-size: 0.95rem;font-weight: 500;cursor: pointer;transition: 0.2s;}
        .menu-item:active {background: rgba(255, 102, 0, 0.15);color: var(--primary-orange);}
        .menu-icon {font-size: 20px;width: 25px;text-align: center}
        /* ç”¨æ–¼æ§åˆ¶é¸å–®æ»‘å…¥çš„é¡åˆ¥ */
        #side-menu.active {left: 0 !important;}
        .star-btn { display: inline-block; cursor: pointer; transition: 0.2s ease; margin-right: 8px; color: rgba(255,255,255,0.2); font-style: normal; vertical-align: middle;}  
        .star-btn.active { color: #FFCC00 !important; transform: scale(1.1); text-shadow: 0 0 10px rgba(255, 204, 0, 0.4);}
        button:active {transform: scale(0.9);opacity: 0.8;}

        #edit-bg-color {border-radius: 10px;overflow: hidden;padding: 0;border: 2px solid rgba(255,255,255,0.1);}
        /* è®“ iOS ä¸Šçš„è‰²ç›¤æŒ‰éˆ•çœ‹èµ·ä¾†æ›´æ‰å¹³åŒ– */
        #edit-bg-color::-webkit-color-swatch-wrapper { padding: 0; }
        #edit-bg-color::-webkit-color-swatch { border: none; }

        /* æ»‘å‹•å®¹å™¨ï¼šéš±è—æº¢å‡º */
       .swipe-item-wrapper {position: relative;overflow: hidden;border-radius: 18px;background: #ff3b30; /* iOS åˆªé™¤ç´… */margin-bottom: 12px;}
        /* å…§å®¹å±¤ï¼šå¹³å¸¸è“‹åœ¨ä¸Šé¢ */
       .swipe-item-content {position: relative;z-index: 2;background: rgba(40, 40, 40, 0.95);backdrop-filter: blur(10px);padding: 15px;border: 1px solid rgba(255, 255, 255, 0.1);border-radius: 18px;transition: transform 0.3s ease;display: flex;justify-content: space-between;align-items: center;}
       /* åˆªé™¤æŒ‰éˆ•å±¤ï¼šè—åœ¨å³å´å¾Œé¢ */
       .swipe-delete-action {position: absolute;right: 0;top: 0;height: 100%;width: 80px;display: flex;align-items: center;justify-content: center;color: white;font-weight: bold;font-size: 0.9rem;z-index: 1;cursor: pointer;}
       
        .container {width: 95%;max-width: 357px;height: 100dvh; /* dvh æ˜¯å‹•æ…‹è¦–çª—é«˜åº¦ï¼Œå°æ‰‹æ©Ÿç€è¦½å™¨å¾ˆå‹å–„ */z-index: 10;display: flex;flex-direction: column;justify-content: space-evenly;align-items: center;/* é—œéµä¿®æ­£ï¼šä¿ç•™é ‚éƒ¨å®‰å…¨å€åŸŸï¼ˆç€æµ·ï¼‰ */padding-top: env(safe-area-inset-top); position: relative;transition: 0.3s;}
       .footer-action {width: 100%;flex: 0 0 auto;display: flex;flex-direction: column;align-items: center;/* é—œéµä¿®æ­£ï¼šä¿ç•™åº•éƒ¨å®‰å…¨å€åŸŸï¼ˆæ©«æ¢ï¼‰ä¸¦å¢åŠ ä¸€é»å‘¼å¸ç©ºé–“ */padding-bottom: calc(env(safe-area-inset-bottom) + 10px);}
       #side-menu {/* ... ä¹‹å‰çš„è¨­å®š ... */padding: calc(env(safe-area-inset-top) + 20px) 20px env(safe-area-inset-bottom) 20px;}
       .card-stack {width: 100%;max-width: 360px;/* ç¢ºä¿å¡ç‰‡å †ç–Šå€å¡Šè€ƒæ…®åˆ°å®‰å…¨å€åŸŸ */padding-top: env(safe-area-inset-top);padding-bottom: env(safe-area-inset-bottom);display: flex;flex-direction: column;align-items: center;gap: 25px;}
    </style>
</head>
<body>
    <div id="api-overlay">
    <div class="api-card">
        <h2 style="color: #fff; margin: 0;">ğŸ”‘ æ¢ç´¢åŠŸèƒ½è¨­å®š</h2>
        <p style="font-size: 0.85rem; color: #888; margin-top: -5px;">è«‹ä¾ç…§å¼•å°é–‹å•Ÿ Google é›²ç«¯æ¬Šé™</p>
        
        <button id="toggle-guide-btn" onclick="toggleApiGuide()">ğŸ“– æŸ¥çœ‹å¿«é€Ÿç”³è«‹æ•™å­¸</button>
                <div id="api-guide-box" style="display: none;"> 
    <div class="guide-steps">
        <div class="step-title"><span class="step-num">1</span> å»ºç«‹é›²ç«¯å°ˆæ¡ˆ</div>
        <a href="https://console.cloud.google.com/projectcreate" target="_blank" class="step-link-btn">å‰å¾€ Google Cloud å»ºç«‹ â”</a>

        <div class="step-title" style="margin-top: 15px;"><span class="step-num">2</span> å•Ÿç”¨å¿…è¦æ¬Šé™</div>
        <div class="api-tag-container" style="display: flex; gap: 8px;">
            <a href="https://console.cloud.google.com/apis/library/places.googleapis.com" target="_blank" class="api-tag" style="flex:1; text-decoration:none;">
                <span style="display:block; color:var(--accent-yellow); font-size:0.75rem; font-weight:800;">Places API</span>
            </a>
            <a href="https://console.cloud.google.com/apis/library/generativelanguage.googleapis.com" target="_blank" class="api-tag" style="flex:1; text-decoration:none;">
                <span style="display:block; color:var(--accent-yellow); font-size:0.75rem; font-weight:800;">Gemini API</span>
            </a>
        </div>

        <div class="step-title" style="margin-top: 15px;"><span class="step-num">3</span> ç”¢ç”Ÿ API é‡‘é‘°</div>
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="step-link-btn">å»ºç«‹æ†‘è­‰ä¸¦è¤‡è£½é‡‘é‘° â”</a>

        <!-- å¼·åŒ–å‘ŠçŸ¥å€å¡Š -->
        <div class="step-title" style="margin-top: 15px;"><span class="step-num">4</span> å•Ÿç”¨çµç®—å¸³æˆ¶ (é‡è¦)</div>
        <div style="background: rgba(46, 204, 113, 0.1); border: 1px dashed #2ecc71; border-radius: 12px; padding: 12px; margin-top: 5px;">
            <p style="font-size: 0.8rem; color: #2ecc71; margin: 0; font-weight: bold;">ğŸ å®‰å¿ƒå‘ŠçŸ¥ï¼šGoogle å®˜æ–¹æ‰¿è«¾</p>
            <p style="font-size: 0.72rem; color: #bbb; margin: 5px 0 0 0; line-height: 1.4;">
                Google åœ°åœ– API æ¯æœˆæä¾› <span style="color:#fff; font-weight:bold;">$200 ç¾é‡‘ (ç´„å°å¹£ $6,400)</span> çš„å…è²»æŠ˜æŠµé¡åº¦ã€‚
                <br><br>
                å°æ–¼å€‹äººæ­£å¸¸ä½¿ç”¨ï¼Œé€™ç­†é¡åº¦<b>å¹¾ä¹ç”¨ä¸å®Œ</b>ï¼Œç¶å®šä¿¡ç”¨å¡åƒ…ä¾›èº«ä»½é©—è­‰ï¼Œé™¤éä½ é–‹ç™¼çš„ App æœ‰æ•¸è¬äººä½¿ç”¨ï¼Œå¦å‰‡ä¸æœƒç”¢ç”Ÿè²»ç”¨ã€‚
            </p>
        </div>
        <p style="font-size: 0.7rem; color: #888; margin: 8px 0 0 5px;">* æœªç¶å®šè€…ï¼ŒGoogle å°‡ä¸å›å‚³ä»»ä½•åœ°åœ–è³‡æ–™ã€‚</p>
    </div>
</div>
        <div style="margin-top: 10px; text-align: center; opacity: 0.6;">
    <span style="font-size: 0.7rem;">ğŸ›¡ï¸ æœ¬ç¶²é ä¸æœƒå‚³è¼¸æˆ–å„²å­˜æ‚¨çš„é‡‘é‘°ï¼Œåƒ…é™æœ¬åœ°ç€è¦½å™¨é‹è¡Œ</span>
</div>
        <div style="margin-top: 5px;">
            <div class="api-instruction" style="text-align: left; font-size: 0.9rem; margin-bottom: 8px;">è²¼ä¸Šæ‚¨çš„ API é‡‘é‘°ï¼š</div>
            <input type="password" id="api-key-input" class="api-input" placeholder="AIzaSyBw-xxxxxx...">
        </div>

        <button class="api-save-btn" onclick="saveApiKey()">å„²å­˜è¨­å®šä¸¦é–‹å•Ÿæ¢ç´¢</button>

        <button onclick="document.getElementById('api-overlay').style.display='none'" style="background:none; border:none; color:#555; cursor:pointer; font-size: 0.85rem; margin-top: 10px;">âœ• æš«ä¸è¨­å®šï¼Œè¿”å›é¦–é </button>
    </div>
</div>
    <div id="bg-container"></div>
   <div id="loader">
    <div class="resonance-container">
        <div class="resonance-wave"></div>
        <div class="resonance-wave"></div>
        <div class="resonance-wave"></div>
        <div class="core-dot"></div>
    </div>
    <p id="loader-text" class="loader-text">æ­£åœ¨åŒæ­¥æ‚¨çš„åœ°ç†åº§æ¨™...</p>
</div> 
    <div class="container" id="main-ui">
        <!-- å…¨æ–° App æ¨™é ­çµæ§‹ -->
<div class="header" style="width: 100%; position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
    
    <!-- å·¦å´é¸å–®è§¸ç™¼æŒ‰éˆ• (å·²èª¿è‡³æœ€å·¦ä¸Šè§’è½) -->
    <div onclick="toggleSideMenu(true)" style="position: absolute; left: 0; top: 4px; font-size: 26px; cursor: pointer; z-index: 100; line-height: 1;">â˜°</div>
    
    <!-- Logo å±…ä¸­ -->
    <div style="width: 100%; text-align: center;">
        <div class="logo" style="margin: 0;">TasteExplorer</div>
        <div class="tagline" style="font-size: 1.1rem; opacity: 0.8; margin-top: 5px; text-align: center; width: 100%;">æ¢ç´¢éš±è—ç¾å‘³ äº«å—æ¥µè‡´é¥—å®´</div>
    </div>
</div>

<!-- å´é‚Šå°è¦½é¸å–® (Side Menu) - ä¿æŒä¸è®Š -->
<div id="menu-overlay" onclick="toggleSideMenu(false)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:10000;">
    <div id="side-menu" onclick="event.stopPropagation()" style="position:absolute; top:0; left:-300px; width:280px; height:100%; background:rgba(20,20,20,0.95); backdrop-filter:blur(20px); border-right:1px solid rgba(255,255,255,0.1); transition: 0.3s; display:flex; flex-direction:column; padding:40px 20px;">
    
    <!-- 1. API ç›£æ§å€ (ç§»åˆ°æœ€ä¸Šæ–¹) -->
    <div class="api-monitor-box" style="background: rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin-bottom:20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 0.7rem; color: #888;">API æµé‡ç›£æ§</span>
            <span id="billing-percent" style="font-size: 0.65rem; color: #2ecc71;">å®‰å…¨</span>
        </div>
        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: 10px; overflow: hidden;">
            <div id="api-usage-bar" style="width: 0%; height: 100%; background: #2ecc71; transition: 0.5s;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><div style="font-size: 0.6rem; color: #666;">é ä¼°æ¶ˆè€—</div><div id="est-cost" style="font-size: 0.9rem; font-weight: bold;">$0.00</div></div>
            <div style="text-align: right;"><div style="font-size: 0.6rem; color: #666;">å‰©é¤˜é¡åº¦</div><div id="free-remain" style="font-size: 0.9rem; font-weight: bold; color: var(--accent-yellow);">$200</div></div>
        </div>
    </div>

    <!-- 2. ä½¿ç”¨è€…è³‡è¨Š -->
    <div class="user-section" onclick="openEditProfile()" style="display:flex; align-items:center; gap:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px; cursor:pointer; margin-bottom:20px;">
        <div id="user-avatar-display" style="width:50px; height:50px; border-radius:50%; background:var(--primary-orange); display:flex; align-items:center; justify-content:center; font-size:24px;">ğŸ‘¤</div>
        <div>
            <div id="user-name-display" style="font-weight:bold; font-size:1.1rem;">ç¾é£Ÿæ¢ç´¢è€…</div>
            <div id="user-level-display" style="font-size:0.75rem; color:var(--accent-yellow);">ç­‰ç´šï¼šè¨ˆç®—ä¸­...</div>
        </div>
    </div>

    <!-- 3. é¸å–®åˆ—è¡¨ -->
    <div class="menu-list" style="display:flex; flex-direction:column; gap:5px;">
        <div class="menu-item" onclick="openApiFromMenu()"><span class="menu-icon">ğŸ”‘</span> API è¨­å®š</div>
        <div class="menu-item" onclick="openHistoryFromMenu('fav')"><span class="menu-icon">â­</span> æˆ‘çš„æœ€æ„›</div>
        <div class="menu-item" onclick="openHistoryFromMenu('all')"><span class="menu-icon">ğŸ•’</span> æ¢ç´¢æ­·å²</div>
        <div class="menu-item" onclick="openSettings()"><span class="menu-icon">âš™ï¸</span> ç³»çµ±è¨­å®š</div>
    </div>
</div>

    <!-- æµé‡ç›£æ§å€å¡Šæ”¾åœ¨é€™è£¡ -->
    <div id="api-dashboard" style="background: rgba(255, 255, 255, 0.03); border-radius: 16px; padding: 15px; margin-top: 5px; border: 1px solid rgba(255, 255, 255, 0.08);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 0.7rem; color: #666; font-weight: 800; letter-spacing: 1px;">API ç”¨é‡ç›£æ§</span>
            <span id="billing-percent" style="font-size: 0.65rem; color: #2ecc71; background: rgba(46, 204, 113, 0.1); padding: 2px 6px; border-radius: 4px;">å®‰å…¨</span>
        </div>
        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-bottom: 10px; overflow: hidden;">
            <div id="api-usage-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #2ecc71, #f1c40f); transition: 0.5s;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <div style="font-size: 0.6rem; color: #555;">æœ¬æœˆé ä¼°</div>
                <div id="est-cost" style="font-size: 0.9rem; font-weight: bold; color: #eee;">$0.00</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.6rem; color: #555;">å‰©é¤˜é¡åº¦</div>
                <div id="free-remain" style="font-size: 0.9rem; font-weight: bold; color: var(--accent-yellow);">$200</div>
            </div>
        </div>
    </div>
</div>

        <div style="margin-top:auto; font-size:0.7rem; color:#444; text-align:center;">TasteExplorer v2.5 Beta</div>
    </div>
</div>
        <div class="glass-card">
            <div id="location-display" class="location-status" onclick="toggleNearbyMode()">
                <div class="location-dot"></div>
                <span id="coords-text">æ­£åœ¨å–å¾— GPS åº§æ¨™...</span>
            </div>
            <div class="form-grid">
                <div class="form-group nearby-toggle"><label>ğŸ“ ç¸£å¸‚</label><div class="input-box"><select id="city" onchange="updateDistricts();">
                    <optgroup label="åŒ—éƒ¨åœ°å€"><option value="Taipei" selected>å°åŒ—å¸‚</option><option value="NewTaipei">æ–°åŒ—å¸‚</option><option value="Keelung">åŸºéš†å¸‚</option><option value="Taoyuan">æ¡ƒåœ’å¸‚</option><option value="HsinchuCity">æ–°ç«¹å¸‚</option><option value="HsinchuCounty">æ–°ç«¹ç¸£</option><option value="Yilan">å®œè˜­ç¸£</option></optgroup>
                    <optgroup label="ä¸­éƒ¨åœ°å€"><option value="Miaoli">è‹—æ —ç¸£</option><option value="Taichung">å°ä¸­å¸‚</option><option value="Changhua">å½°åŒ–ç¸£</option><option value="Nantou">å—æŠ•ç¸£</option><option value="Yunlin">é›²æ—ç¸£</option></optgroup>
                    <optgroup label="å—éƒ¨åœ°å€"><option value="ChiayiCity">å˜‰ç¾©å¸‚</option><option value="ChiayiCounty">å˜‰ç¾©ç¸£</option><option value="Tainan">å°å—å¸‚</option><option value="Kaohsiung">é«˜é›„å¸‚</option><option value="Pingtung">å±æ±ç¸£</option></optgroup>
                    <optgroup label="æ±éƒ¨èˆ‡é›¢å³¶"><option value="Hualien">èŠ±è“®ç¸£</option><option value="Taitung">å°æ±ç¸£</option><option value="Penghu">æ¾æ¹–ç¸£</option><option value="Kinmen">é‡‘é–€ç¸£</option><option value="Lienchiang">é€£æ±Ÿç¸£</option></optgroup>
                </select></div></div>
                <div class="form-group nearby-toggle"><label>ğŸ™ï¸ è¡Œæ”¿å€</label><div class="input-box"><select id="district" onchange="checkTransAvailability();"><option>å…¨å€</option></select></div></div>
                <div class="form-group full-width nearby-toggle"><label id="transport-main-label">ğŸš† äº¤é€šåå¥½</label><div class="input-box"><select id="transport" onchange="checkTransAvailability()">
                    <option value="none" selected>ğŸ¤·â€â™‚ï¸ ä¸æ‹˜</option>
                    <option value="mrt">ğŸš‡ é„°è¿‘æ·é‹ç«™</option>
                    <option value="hsr">ğŸš„ é„°è¿‘é«˜éµç«™</option>
                    <option value="train">ğŸš‚ é„°è¿‘ç«è»Šç«™</option>
                    <option value="airport">âœˆï¸ é„°è¿‘æ©Ÿå ´</option>
                </select></div></div>
                <div class="form-group full-width" id="mrt-section" style="display:none;"><label id="trans-label">ğŸš‰ æŒ‡å®šç«™é»</label><div class="input-box"><select id="mrt-station"></select></div></div>
                <div class="form-group full-width"><label>ğŸ¤¤ æƒ³åƒä»€éº¼ï¼Ÿ</label><div class="input-box"><select id="food">
                    <option value="all">å…¨éƒ¨ (ä»€éº¼éƒ½æƒ³åƒ)</option>
                    <optgroup label="ğŸ”¥ ç†±é–€ç²¾é¸"><option value="hotpot">ç«é‹ / éº»è¾£é‹ / æ¶®æ¶®é‹</option><option value="bbq">ç‡’è‚‰ / æ—¥å¼çƒ¤è‚‰ / éŸ“å¼çƒ¤è‚‰</option><option value="steak">ç‰›æ’ / éµæ¿ç‡’</option><option value="buffet">åƒåˆ°é£½ (Buffet)</option></optgroup>
                    <optgroup label="ğŸœ å°å¼èˆ‡ä¸­å¼"><option value="taiwanese_snack">å°ç£å°åƒ / è·¯é‚Šæ”¤</option><option value="beef_noodle">ç‰›è‚‰éºµ</option><option value="rechao">æµ·é®®ç†±ç‚’ / åˆèœ</option><option value="hot_soup">æ»·å‘³ / é¹½é…¥é› / å®µå¤œ</option></optgroup>
                    <optgroup label="ğŸ£ æ—¥å¼æ–™ç†"><option value="ramen">æ—¥å¼æ‹‰éºµ / çƒé¾éºµ</option><option value="sushi">å£½å¸ / ç”Ÿé­šç‰‡ / ä¸¼é£¯</option><option value="izakaya">å±…é…’å±‹ / ä¸²ç‡’</option><option value="curry">æ—¥å¼å’–å“© / å®šé£Ÿ</option></optgroup>
                    <optgroup label="ğŸŒ ç•°åœ‹é¢¨å‘³"><option value="korean">éŸ“å¼æ–™ç† / ç‚¸é›</option><option value="thai_viet">æ³°å¼ / è¶Šå¼æ–™ç†</option><option value="american">ç¾å¼æ¼¢å ¡ / ç‚¸ç‰©</option><option value="italian">ç¾©å¼æ–™ç† / æŠ«è–© / ç¾©å¤§åˆ©éºµ</option></optgroup>
                    <optgroup label="â˜• æ”¾é¬†æ™‚åˆ»"><option value="brunch">æ—©åˆé¤ (Brunch)</option><option value="cafe">å’–å•¡å»³ / ä¸‹åˆèŒ¶ / ç”œé»</option><option value="bistro">é¤é…’é¤¨ / Bar</option></optgroup>
                    <optgroup label="ğŸ¥¬ å…¶ä»–"><option value="vegetarian">ç´ é£Ÿ / è”¬é£Ÿ</option><option value="healthy">å¥åº·é¤ç›’ / è¼•é£Ÿ</option></optgroup>
                </select></div></div>
                <div class="form-group full-width"><label>ğŸ‘¥ äººæ•¸</label><div class="input-box"><select id="people"><option selected>1~2 äºº</option><option>2~4 äºº</option><option>4~6 äºº</option><option>6 äººä»¥ä¸Š</option></select></div></div>
                <div class="form-group full-width"><label>ğŸ¯ ç”¨é¤ç›®çš„</label><div class="input-box"><select id="purpose"><option>ğŸ¤·â€â™‚ï¸ ä¸æ‹˜ (éš¨æ„åƒåƒ)</option><option>ğŸ‘¯ æœ‹å‹èšé¤ (ç†±é¬§)</option><option>ğŸ’‘ æƒ…ä¾¶ç´„æœƒ (æ°£æ°›)</option><option>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­èšæœƒ (é•·è¼©/å°å­©)</option><option>ğŸ§˜ ä¸€äººç¨äº« (å®‰éœ)</option><option>ğŸ’¼ å•†å‹™å®´è«‹ (æ­£å¼)</option><option>ğŸŒ™ å®µå¤œå ´ (æ·±å¤œ)</option><option>ğŸ“¸ IGæ‰“å¡/ç¶²ç¾åº—</option><option>âš¡ å¿«é€Ÿè§£æ±º (è¶•æ™‚é–“)</option><option>ğŸ‰ æ…¶ç”Ÿ/ç´€å¿µæ—¥</option></select></div></div>
                <div class="form-group full-width"><label>ğŸ’° é ç®—ç¯„åœ</label><div class="input-box"><select id="budget"><option value="low">ğŸ’µ å¹³åƒ¹ (&lt;$300)</option><option value="mid">ğŸ’µğŸ’µ ä¸­åƒ¹ä½ ($300ï½$800)</option><option value="high">ğŸ’µğŸ’µğŸ’µ é«˜ç´š (&gt;$800)</option><option value="luxury">ğŸ’ é ‚ç´šå¥¢è¯ (&gt;$2000)</option></select></div></div>
                <div class="form-group full-width"><div class="toggle-row"><div id="btn-hidden" class="toggle-btn" onclick="this.classList.toggle('selected')">ğŸ¤« éš±è—ç‰ˆ</div><div id="btn-open" class="toggle-btn" onclick="this.classList.toggle('selected')">ğŸ•’ ç‡Ÿæ¥­ä¸­</div></div></div>
            </div>
        </div>
        <div class="footer-action">
            <button id="search-btn" class="cta-button" onclick="handleSearchClick()">é–‹å§‹æ¢ç´¢ç¾é£Ÿ</button>
        </div>
        <div id="usage-text" class="usage-hint">ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š-- æ¬¡</div>
    </div>
    <div id="swiper-overlay">
        <div class="card-stack" id="card-stack"></div>
        <div id="no-match-modal">
    <div class="modal-icon">ğŸ”</div>
    <h3>æ²’æœ‰å¿ƒå„€çš„åº—å®¶å—ï¼Ÿ</h3>
    <p>åˆ¥æ“”å¿ƒï¼Œç¾é£Ÿå°±åœ¨ä¸é è™•ã€‚<br>è©¦è‘—èª¿æ•´æœå°‹æ¢ä»¶ï¼Œå†æ¬¡æ¢ç´¢å§ï¼</p>
    <button class="modal-retry-btn" onclick="resetUI()">è¿”å›ä¸¦é‡æ–°æ¢ç´¢</button>
</div>
    </div>
    <script>
        const DAILY_LIMIT = 20;
        let userCoords = { lat: null, lng: null };
        let isNearbyMode = false;
        let keptRestaurants = []; 
        let isFinalOne = false;
        let loaderInterval;
        const images = ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1', 'https://images.unsplash.com/photo-1594046243098-0fceea9d451e', 'https://images.unsplash.com/photo-1563245372-f21724e3856d', 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd', 'https://images.unsplash.com/photo-1504674900247-0877df9cc836', 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38'];
        const cityData = { 'Taipei': ['å…¨å€', 'ä¸­æ­£å€', 'å¤§åŒå€', 'ä¸­å±±å€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'], 'NewTaipei': ['å…¨å€', 'æ¿æ©‹å€', 'ä¸‰é‡å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'æ–°èŠå€', 'æ–°åº—å€', 'åœŸåŸå€', 'è˜†æ´²å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'ä¸‰å³½å€', 'æ·¡æ°´å€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'äº”è‚¡å€', 'æ³°å±±å€', 'æ—å£å€', 'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'å…«é‡Œå€', 'å¹³æºªå€', 'é›™æºªå€', 'è²¢å¯®å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'çƒä¾†å€'], 'Keelung': ['å…¨å€', 'ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'], 'Taoyuan': ['å…¨å€', 'æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'é¾œå±±å€', 'å¤§åœ’å€', 'è§€éŸ³å€', 'æ–°å±‹å€', 'å¾©èˆˆå€'], 'HsinchuCity': ['å…¨å€', 'æ±å€', 'åŒ—å€', 'é¦™å±±å€'], 'HsinchuCounty': ['å…¨å€', 'ç«¹åŒ—å¸‚', 'ç«¹æ±é®', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'å³¨çœ‰é„‰', 'å¯¶å±±é„‰', 'åŒ—åŸ”é„‰', 'æ©«å±±é„‰', 'èŠæ—é„‰', 'å°–çŸ³é„‰', 'äº”å³°é„‰'], 'Yilan': ['å…¨å€', 'å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'é ­åŸé®', 'ç¤æºªé„‰', 'å£¯åœé„‰', 'å“¡å±±é„‰', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'], 'Miaoli': ['å…¨å€', 'è‹—æ —å¸‚', 'é ­ä»½å¸‚', 'ç«¹å—é®', 'å¾Œé¾é®', 'é€šéœ„é®', 'è‹‘è£¡é®', 'å“è˜­é®', 'é€ æ©‹é„‰', 'è¥¿æ¹–é„‰', 'é ­å±‹é„‰', 'å…¬é¤¨é„‰', 'éŠ…é‘¼é„‰', 'ä¸‰ç¾©é„‰', 'å¤§æ¹–é„‰', 'ç…æ½­é„‰', 'ä¸‰ç£é„‰', 'å—åº„é„‰', 'æ³°å®‰é„‰'], 'Taichung': ['å…¨å€', 'ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'å¾Œé‡Œå€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'], 'Changhua': ['å…¨å€', 'å½°åŒ–å¸‚', 'å“¡æ—å¸‚', 'å’Œç¾é®', 'é¹¿æ¸¯é®', 'æºªæ¹–é®', 'äºŒæ—é®', 'ç”°ä¸­é®', 'åŒ—æ–—é®', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'æ°¸é–é„‰', 'ä¼¸æ¸¯é„‰', 'ç·šè¥¿é„‰', 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'å¤§åŸé„‰', 'èŠ³è‹‘é„‰', 'ç«¹å¡˜é„‰', 'ç¤¾é ­é„‰', 'äºŒæ°´é„‰', 'æºªå·é„‰', 'ç”°å°¾é„‰', 'åŸ¤é ­é„‰'], 'Nantou': ['å…¨å€', 'å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'åé–“é„‰', 'é¹¿è°·é„‰', 'ä¸­å¯®é„‰', 'é­šæ± é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'], 'Yunlin': ['å…¨å€', 'æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'åŒ—æ¸¯é®', 'å¤å‘é„‰', 'å¤§åŸ¤é„‰', 'è¿æ¡é„‰', 'æ—å…§é„‰', 'äºŒå´™é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ±å‹¢é„‰', 'è¤’å¿ é„‰', 'å°è¥¿é„‰', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'], 'ChiayiCity': ['å…¨å€', 'æ±å€', 'è¥¿å€'], 'ChiayiCounty': ['å…¨å€', 'å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'å¤§æ—é®', 'æ°‘é›„é„‰', 'æºªå£é„‰', 'æ–°æ¸¯é„‰', 'å…­è…³é„‰', 'æ±çŸ³é„‰', 'ç¾©ç«¹é„‰', 'é¹¿è‰é„‰', 'æ°´ä¸Šé„‰', 'ä¸­åŸ”é„‰', 'ç«¹å´é„‰', 'æ¢…å±±é„‰', 'ç•ªè·¯é„‰', 'å¤§åŸ”é„‰', 'é˜¿é‡Œå±±é„‰'], 'Tainan': ['å…¨å€', 'ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'ç‰äº•å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'æ–°ç‡Ÿå€', 'å–„åŒ–å€'], 'Kaohsiung': ['å…¨å€', 'æ¥ æ¢“å€', 'å·¦ç‡Ÿå€', 'é¼“å±±å€', 'ä¸‰æ°‘å€', 'é¹½åŸ•å€', 'å‰é‡‘å€', 'æ–°èˆˆå€', 'è‹“é›…å€', 'å‰é®å€', 'æ——æ´¥å€', 'å°æ¸¯å€', 'é³³å±±å€', 'å¤§å¯®å€', 'é³¥æ¾å€', 'æ—åœ’å€', 'ä»æ­¦å€', 'å¤§æ¨¹å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€'], 'Pingtung': ['å…¨å€', 'å±æ±å¸‚', 'æ½®å·é®', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'è¬ä¸¹é„‰', 'é•·æ²»é„‰', 'é‡Œæ¸¯é„‰', 'å…§åŸ”é„‰', 'æ‹å¯®é„‰', 'è»ŠåŸé„‰'], 'Hualien': ['å…¨å€', 'èŠ±è“®å¸‚', 'é³³æ—é®', 'ç‰é‡Œé®', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å£½è±é„‰', 'å…‰å¾©é„‰', 'ç‘ç©—é„‰'], 'Taitung': ['å…¨å€', 'å°æ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'å‘åé„‰', 'é¹¿é‡é„‰', 'æ± ä¸Šé„‰', 'ç¶ å³¶é„‰', 'è˜­å¶¼é„‰'], 'Penghu': ['å…¨å€', 'é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'è¥¿å¶¼é„‰'], 'Kinmen': ['å…¨å€', 'é‡‘åŸé®', 'é‡‘æ¹–é®', 'é‡‘æ²™é®', 'é‡‘å¯§é„‰'], 'Lienchiang': ['å…¨å€', 'å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'è’å…‰é„‰', 'æ±å¼•é„‰'] };
        // ==========================================// 1. æ·é‹ç·šè·¯æ•¸æ“š (æŒ‰ç¸£å¸‚é‚Šç•Œåš´æ ¼åˆ‡å‰²)
        const mrtLinesTaipei = {
            'æ¿å—ç·š (BL)': ['é¾å±±å¯º', 'è¥¿é–€', 'å°åŒ—è»Šç«™', 'å–„å°å¯º', 'å¿ å­æ–°ç”Ÿ', 'å¿ å­å¾©èˆˆ', 'å¿ å­æ•¦åŒ–', 'åœ‹çˆ¶ç´€å¿µé¤¨', 'å¸‚æ”¿åºœ', 'æ°¸æ˜¥', 'å¾Œå±±åŸ¤', 'æ˜†é™½', 'å—æ¸¯', 'å—æ¸¯å±•è¦½é¤¨'],
            'æ·¡æ°´ä¿¡ç¾©ç·š (R)': ['è±¡å±±', 'å°åŒ—101/ä¸–è²¿', 'ä¿¡ç¾©å®‰å’Œ', 'å¤§å®‰', 'å¤§å®‰æ£®æ—å…¬åœ’', 'æ±é–€', 'ä¸­æ­£ç´€å¿µå ‚', 'å°å¤§é†«é™¢', 'å°åŒ—è»Šç«™', 'ä¸­å±±', 'é›™é€£', 'æ°‘æ¬Šè¥¿è·¯', 'åœ“å±±', 'åŠæ½­', 'å£«æ—', 'èŠå±±', 'æ˜å¾·', 'çŸ³ç‰Œ', 'å”­å“©å²¸', 'å¥‡å²©', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•', 'å¾©èˆˆå´—', 'å¿ ç¾©', 'é—œæ¸¡'],
            'æ¾å±±æ–°åº—ç·š (G)': ['è¬éš†', 'å…¬é¤¨', 'å°é›»å¤§æ¨“', 'å¤äº­', 'ä¸­æ­£ç´€å¿µå ‚', 'å°å—é–€', 'è¥¿é–€', 'åŒ—é–€', 'ä¸­å±±', 'æ¾æ±Ÿå—äº¬', 'å—äº¬å¾©èˆˆ', 'å°åŒ—å°å·¨è›‹', 'å—äº¬ä¸‰æ°‘', 'æ¾å±±'],
            'ä¸­å’Œæ–°è˜†ç·š (O)': ['å¤äº­', 'æ±é–€', 'å¿ å­æ–°ç”Ÿ', 'æ¾æ±Ÿå—äº¬', 'è¡Œå¤©å®®', 'ä¸­å±±åœ‹å°', 'æ°‘æ¬Šè¥¿è·¯', 'å¤§æ©‹é ­'],
            'æ–‡æ¹–ç·š (BR)': ['å‹•ç‰©åœ’', 'æœ¨æŸµ', 'è¬èŠ³ç¤¾å€', 'è¬èŠ³é†«é™¢', 'è¾›äº¥', 'éºŸå…‰', 'å…­å¼µçŠ', 'ç§‘æŠ€å¤§æ¨“', 'å¤§å®‰', 'å¿ å­å¾©èˆˆ', 'å—äº¬å¾©èˆˆ', 'ä¸­å±±åœ‹ä¸­', 'æ¾å±±æ©Ÿå ´', 'å¤§ç›´', 'åŠå—è·¯', 'è¥¿æ¹–', 'æ¸¯å¢˜', 'æ–‡å¾·', 'å…§æ¹–', 'å¤§æ¹–å…¬åœ’', 'è‘«æ´²', 'æ±æ¹–', 'å—æ¸¯è»Ÿé«”åœ’å€', 'å—æ¸¯å±•è¦½é¤¨'],
            'æ©Ÿå ´æ·é‹ (A)': ['å°åŒ—è»Šç«™']};
        const mrtLinesNewTaipei = {
            'æ¿å—ç·š (BL)': ['é ‚åŸ”', 'æ°¸å¯§', 'åœŸåŸ', 'æµ·å±±', 'äºæ±é†«é™¢', 'åºœä¸­', 'æ¿æ©‹', 'æ–°åŸ”', 'æ±Ÿå­ç¿ '],
            'æ·¡æ°´ä¿¡ç¾©ç·š (R)': ['ç«¹åœ', 'ç´…æ¨¹æ—', 'æ·¡æ°´'],
            'æ¾å±±æ–°åº—ç·š (G)': ['æ–°åº—', 'æ–°åº—å€å…¬æ‰€', 'ä¸ƒå¼µ', 'å¤§åªæ—'],
            'ä¸­å’Œæ–°è˜†ç·š (O)': ['å—å‹¢è§’', 'æ™¯å®‰', 'æ°¸å®‰å¸‚å ´', 'é ‚æºª', 'ä¸‰é‡åœ‹å°', 'ä¸‰å’Œåœ‹ä¸­', 'å¾åŒ¯ä¸­å­¸', 'ä¸‰æ°‘é«˜ä¸­', 'è˜†æ´²', 'å°åŒ—æ©‹', 'èœå¯®', 'ä¸‰é‡', 'å…ˆå—‡å®®', 'é ­å‰åº„', 'æ–°èŠ', 'è¼”å¤§', 'ä¸¹é³³', 'è¿´é¾'],
            'ç’°ç‹€ç·š (Y)': ['å¤§åªæ—', 'åå››å¼µ', 'ç§€æœ—æ©‹', 'æ™¯å¹³', 'æ™¯å®‰', 'ä¸­å’Œ', 'æ©‹å’Œ', 'ä¸­åŸ', 'æ¿æ–°', 'æ¿æ©‹', 'æ–°åŸ”æ°‘ç”Ÿ', 'é ­å‰åº„', 'å¹¸ç¦', 'æ–°åŒ—ç”¢æ¥­åœ’å€'],
            'æ·¡æµ·è¼•è»Œ (V)': ['ç´…æ¨¹æ—', 'ç«¿è“æ—', 'æ·¡é‡‘é„§å…¬', 'æ·¡æ±Ÿå¤§å­¸', 'æ·¡é‡‘åŒ—æ–°', 'æ–°å¸‚ä¸€è·¯', 'æ·¡æ°´è¡Œæ”¿ä¸­å¿ƒ', 'æ¿±æµ·ç¾©å±±', 'æ¿±æµ·æ²™å´™', 'æ·¡æµ·æ–°å¸‚é®', 'å´é ‚', 'å°åŒ—æµ·æ´‹å¤§å­¸', 'æ²™å´™', 'æ¼äººç¢¼é ­'],
            'å®‰å‘è¼•è»Œ (K)': ['é›™åŸ', 'ç«ç‘°ä¸­åœ‹åŸ', 'å°åŒ—å°åŸ', 'è€•è˜å®‰åº·åˆ†é™¢', 'å®‰åº·', 'æ™¯æ–‡ç§‘å¤§', 'é™½å…‰é‹å‹•å…¬åœ’', 'æ–°å’Œåœ‹å°', 'åå››å¼µ'],
            'æ©Ÿå ´æ·é‹ (A)': ['ä¸‰é‡', 'æ–°åŒ—ç”¢æ¥­åœ’å€', 'æ–°èŠå‰¯éƒ½å¿ƒ', 'æ³°å±±', 'æ³°å±±è²´å’Œ', 'é«”è‚²å¤§å­¸', 'æ—å£']};
        const mrtLinesTaoyuan = {
            'æ©Ÿå ´æ·é‹ (A)': ['é«”è‚²å¤§å­¸', 'é•·åºšé†«é™¢', 'æ—å£', 'å±±é¼»', 'å‘å£', 'æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', 'æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ', 'æ©Ÿå ´æ—…é¤¨', 'å¤§åœ’', 'æ©«å±±', 'é ˜èˆª', 'é«˜é«”æ¡ƒåœ’ç«™', 'æ¡ƒåœ’é«”è‚²åœ’å€', 'èˆˆå—', 'ç’°åŒ—', 'è€è¡—æºª']};
        const mrtLinesTaichung = {
            'ç¶ ç·š': ['åŒ—å±¯ç¸½ç«™', 'èˆŠç¤¾', 'æ¾ç«¹', 'å››ç¶­åœ‹å°', 'æ–‡å¿ƒå´‡å¾·', 'æ–‡å¿ƒä¸­æ¸…', 'æ–‡è¯é«˜ä¸­', 'æ–‡å¿ƒæ«»èŠ±', 'å¸‚æ”¿åºœ', 'æ°´å®‰å®®', 'æ–‡å¿ƒæ£®æ—å…¬åœ’', 'å—å±¯', 'è±æ¨‚å…¬åœ’', 'å¤§æ…¶', 'ä¹å¼µçŠ', 'ä¹å¾·', 'çƒæ—¥', 'é«˜éµå°ä¸­ç«™']};
        const mrtLinesKaohsiung = {
            'ç´…ç·š (R)': ['å°æ¸¯', 'é«˜é›„åœ‹éš›æ©Ÿå ´', 'è‰è¡™', 'å‰é®é«˜ä¸­', 'å‡±æ—‹', 'ç…ç”²', 'ä¸‰å¤šå•†åœˆ', 'ä¸­å¤®å…¬åœ’', 'ç¾éº—å³¶', 'é«˜é›„è»Šç«™', 'å¾Œé©›', 'å‡¹å­åº•', 'å·¨è›‹', 'ç”Ÿæ…‹åœ’å€', 'å·¦ç‡Ÿ', 'ä¸–é‹', 'æ²¹å» åœ‹å°', 'æ¥ æ¢“åŠ å·¥å€', 'å¾Œå‹', 'éƒ½æœƒå…¬åœ’', 'æ©‹é ­è»Šç«™', 'æ©‹é ­ç«è»Šç«™', 'å²¡å±±æ¨‚è³¼', 'å²¡å±±è»Šç«™'],
            'æ©˜ç·š (O)': ['å“ˆç‘ªæ˜Ÿ', 'é¹½åŸ•åŸ”', 'å¸‚è­°æœƒ', 'ç¾éº—å³¶', 'ä¿¡ç¾©åœ‹å°', 'æ–‡åŒ–ä¸­å¿ƒ', 'äº”å¡Šå', 'æŠ€æ“Šé¤¨', 'è¡›æ­¦ç‡Ÿ', 'é³³å±±è¥¿ç«™', 'é³³å±±', 'å¤§æ±', 'é³³å±±åœ‹ä¸­', 'å¤§å¯®'],
            'ç’°ç‹€è¼•è»Œ (C)': ['ç±¬ä»”å…§', 'å‡±æ—‹ç‘ç”°', 'å‰é®ä¹‹æ˜Ÿ', 'å‡±æ—‹ä¸­è¯', 'å¤¢æ™‚ä»£', 'ç¶“è²¿åœ’å€', 'è»Ÿé«”åœ’å€', 'é«˜é›„å±•è¦½é¤¨', 'å…‰æ¦®ç¢¼é ­', 'çœŸæ„›ç¢¼é ­', 'é§äºŒå¤§ç¾©', 'é§äºŒè“¬èŠ', 'å“ˆç‘ªæ˜Ÿ', 'å£½å±±å…¬åœ’', 'æ–‡æ­¦è–æ®¿', 'é¼“å±±å€å…¬æ‰€', 'é¼“å±±', 'é¦¬å¡é“', 'å…§æƒŸè—è¡“ä¸­å¿ƒ', 'ç¾è¡“é¤¨', 'è¯åˆé†«é™¢', 'é¾è¯åœ‹å°', 'æ„›æ²³ä¹‹å¿ƒ', 'æ–°ä¸Šåœ‹å°', 'ç£ä»”å…§', 'é¼å±±è¡—', 'é«˜é›„é«˜å·¥', 'æ¨¹å¾·å®¶å•†', 'ç§‘å·¥é¤¨', 'è–åŠŸé†«é™¢', 'å‡±æ—‹å…¬åœ’', 'è¡›ç”Ÿå±€', 'äº”æ¬Šåœ‹å°', 'è¼•è»Œæ©Ÿå» ']};
        const mrtMap = {
            'Taipei': {
                'ä¸­æ­£å€': ['å°åŒ—è»Šç«™', 'å–„å°å¯º', 'å¿ å­æ–°ç”Ÿ', 'ä¸­æ­£ç´€å¿µå ‚', 'å¤äº­', 'è¥¿é–€', 'å°å¤§é†«é™¢', 'å°å—é–€'],
                'è¬è¯å€': ['è¥¿é–€', 'é¾å±±å¯º'],
                'å¤§å®‰å€': ['å¿ å­å¾©èˆˆ', 'å¿ å­æ•¦åŒ–', 'åœ‹çˆ¶ç´€å¿µé¤¨', 'ä¿¡ç¾©å®‰å’Œ', 'å¤§å®‰', 'ç§‘æŠ€å¤§æ¨“', 'å…­å¼µçŠ', 'å¿ å­æ–°ç”Ÿ', 'æ±é–€', 'å¤§å®‰æ£®æ—å…¬åœ’', 'å…¬é¤¨', 'å°é›»å¤§æ¨“', 'å¤äº­'],
                'ä¿¡ç¾©å€': ['å¸‚æ”¿åºœ', 'æ°¸æ˜¥', 'å¾Œå±±åŸ¤', 'è±¡å±±', 'å°åŒ—101/ä¸–è²¿'],
                'ä¸­å±±å€': ['ä¸­å±±', 'é›™é€£', 'æ°‘æ¬Šè¥¿è·¯', 'åœ“å±±', 'æ¾æ±Ÿå—äº¬', 'è¡Œå¤©å®®', 'ä¸­å±±åœ‹å°', 'å—äº¬å¾©èˆˆ', 'åŠå—è·¯', 'å¤§ç›´', 'ä¸­å±±åœ‹ä¸­'],
                'æ¾å±±å€': ['å—äº¬å¾©èˆˆ', 'å°åŒ—å°å·¨è›‹', 'å—äº¬ä¸‰æ°‘', 'æ¾å±±', 'æ¾å±±æ©Ÿå ´', 'ä¸­å±±åœ‹ä¸­'],
                'å¤§åŒå€': ['å¤§æ©‹é ­', 'ä¸­å±±', 'åœ“å±±', 'æ°‘æ¬Šè¥¿è·¯', 'é›™é€£', 'åŒ—é–€'],
                'å£«æ—å€': ['åŠæ½­', 'å£«æ—', 'èŠå±±', 'æ˜å¾·'],
                'åŒ—æŠ•å€': ['çŸ³ç‰Œ', 'å”­å“©å²¸', 'å¥‡å²©', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•', 'å¾©èˆˆå´—', 'å¿ ç¾©', 'é—œæ¸¡'],
                'å…§æ¹–å€': ['è¥¿æ¹–', 'æ¸¯å¢˜', 'æ–‡å¾·', 'å…§æ¹–', 'å¤§æ¹–å…¬åœ’', 'è‘«æ´²', 'æ±æ¹–'],
                'å—æ¸¯å€': ['å—æ¸¯', 'å—æ¸¯å±•è¦½é¤¨', 'å—æ¸¯è»Ÿé«”åœ’å€', 'æ˜†é™½'],
                'æ–‡å±±å€': ['å‹•ç‰©åœ’', 'æœ¨æŸµ', 'è¬èŠ³é†«é™¢', 'è¾›äº¥', 'æ™¯ç¾', 'è¬éš†']},
            'NewTaipei': {
                'æ¿æ©‹å€': ['æ¿æ©‹', 'åºœä¸­', 'æ–°åŸ”', 'æ±Ÿå­ç¿ ', 'äºæ±é†«é™¢', 'æ–°åŸ”æ°‘ç”Ÿ', 'æ¿æ–°'],
                'ä¸‰é‡å€': ['ä¸‰é‡', 'èœå¯®', 'å°åŒ—æ©‹', 'ä¸‰é‡åœ‹å°', 'ä¸‰å’Œåœ‹ä¸­', 'å¾åŒ¯ä¸­å­¸', 'å…ˆå—‡å®®'],
                'ä¸­å’Œå€': ['æ™¯å®‰', 'å—å‹¢è§’', 'æ°¸å®‰å¸‚å ´', 'ä¸­å’Œ', 'æ©‹å’Œ', 'ä¸­åŸ', 'æ™¯å¹³', 'ç§€æœ—æ©‹'],
                'æ°¸å’Œå€': ['é ‚æºª', 'æ°¸å®‰å¸‚å ´'],
                'æ–°èŠå€': ['æ–°èŠ', 'è¼”å¤§', 'ä¸¹é³³', 'è¿´é¾', 'é ­å‰åº„', 'å¹¸ç¦', 'æ–°åŒ—ç”¢æ¥­åœ’å€', 'æ–°èŠå‰¯éƒ½å¿ƒ'],
                'æ–°åº—å€': ['æ–°åº—', 'æ–°åº—å€å…¬æ‰€', 'ä¸ƒå¼µ', 'å¤§åªæ—', 'å°ç¢§æ½­', 'åå››å¼µ', 'å®‰åº·', 'ç«ç‘°ä¸­åœ‹åŸ', 'é™½å…‰é‹å‹•å…¬åœ’', 'æ–°å’Œåœ‹å°'],
                'åœŸåŸå€': ['æµ·å±±', 'åœŸåŸ', 'æ°¸å¯§', 'é ‚åŸ”'],
                'è˜†æ´²å€': ['è˜†æ´²', 'ä¸‰æ°‘é«˜ä¸­', 'å¾åŒ¯ä¸­å­¸'],
                'æ·¡æ°´å€': ['æ·¡æ°´', 'ç´…æ¨¹æ—', 'ç«¹åœ', 'ç«¿è“æ—', 'æ·¡é‡‘é„§å…¬', 'æ·¡æ±Ÿå¤§å­¸', 'æ·¡æ°´è¡Œæ”¿ä¸­å¿ƒ', 'æ¼äººç¢¼é ­', 'æ·¡æµ·æ–°å¸‚é®'],
                'æ—å£å€': ['æ—å£'], 'æ³°å±±å€': ['æ³°å±±', 'æ³°å±±è²´å’Œ'], 'äº”è‚¡å€': ['æ–°åŒ—ç”¢æ¥­åœ’å€']}};
        const trainMap = {
            'Keelung': { 'å…¨å€': ['åŸºéš†', 'ä¸‰å‘', 'å…«å µ', 'ä¸ƒå µ', 'ç™¾ç¦', 'æš–æš–', 'æµ·ç§‘é¤¨', 'å…«æ–—å­'] },
            'Taipei': { 'ä¸­æ­£å€': ['å°åŒ—è»Šç«™'], 'è¬è¯å€': ['è¬è¯'], 'æ¾å±±å€': ['æ¾å±±'], 'å—æ¸¯å€': ['å—æ¸¯'] },
            'NewTaipei': {
                'æ¿æ©‹å€': ['æ¿æ©‹', 'æµ®æ´²'],
                'æ±æ­¢å€': ['æ±æ­¢', 'æ±ç§‘', 'äº”å µ'],
                'æ¨¹æ—å€': ['æ¨¹æ—', 'å—æ¨¹æ—', 'å±±ä½³'],
                'é¶¯æ­Œå€': ['é¶¯æ­Œ'],
                'ç‘èŠ³å€': ['ç‘èŠ³', 'çŒ´ç¡', 'ä¸‰è²‚å¶º', 'å››è…³äº­'],
                'é›™æºªå€': ['é›™æºª', 'ç‰¡ä¸¹'],
                'è²¢å¯®å€': ['è²¢å¯®', 'ç¦éš†'],
                'å¹³æºªå€': ['å¹³æºª', 'èæ¡', 'ååˆ†', 'å¶ºè…³', 'æœ›å¤', 'å¤§è¯']},
            'Taoyuan': { 'æ¡ƒåœ’å€': ['æ¡ƒåœ’'], 'ä¸­å£¢å€': ['ä¸­å£¢', 'å…§å£¢'], 'æ¥Šæ¢…å€': ['æ¥Šæ¢…', 'åŸ”å¿ƒ', 'å¯Œå²¡', 'æ–°å¯Œ'] },
            'HsinchuCity': { 'æ±å€': ['æ–°ç«¹', 'åŒ—æ–°ç«¹', 'åƒç”²', 'æ–°èŠ'], 'é¦™å±±å€': ['é¦™å±±', 'ä¸‰å§“æ©‹'] },
            'HsinchuCounty': { 'ç«¹åŒ—å¸‚': ['ç«¹åŒ—'], 'ç«¹æ±é®': ['ç«¹æ±', 'æ¦®è¯', 'ä¸Šå“¡'], 'æ¹–å£é„‰': ['æ¹–å£', 'æ–°è±'] },
            'Miaoli': { 'è‹—æ —å¸‚': ['è‹—æ —'], 'ç«¹å—é®': ['ç«¹å—'], 'å¾Œé¾é®': ['å¾Œé¾', 'è±å¯Œ', 'å¤§å±±'], 'é€šéœ„é®': ['é€šéœ„', 'ç™½æ²™å±¯'], 'è‹‘è£¡é®': ['è‹‘è£¡'], 'ä¸‰ç¾©é„‰': ['ä¸‰ç¾©'] },
            'Taichung': {
                'ä¸­å€': ['å°ä¸­'], 'æ±å€': ['ç²¾æ­¦'], 'å—å€': ['äº”æ¬Š', 'å¤§æ…¶'], 'åŒ—å±¯å€': ['å¤ªåŸ', 'æ¾ç«¹'], 
                'çƒæ—¥å€': ['çƒæ—¥', 'æ–°çƒæ—¥', 'æˆåŠŸ'], 'è±åŸå€': ['è±åŸ'], 'æ½­å­å€': ['æ½­å­', 'æ —æ—'], 
                'å¤§è‚šå€': ['å¤§è‚š', 'è¿½åˆ†'], 'æ¸…æ°´å€': ['æ¸…æ°´'], 'æ²™é¹¿å€': ['æ²™é¹¿'], 'åé‡Œå€': ['åé‡Œ', 'æ³°å®‰']},
            'Changhua': { 'å½°åŒ–å¸‚': ['å½°åŒ–'], 'å“¡æ—å¸‚': ['å“¡æ—'], 'ç”°ä¸­é®': ['ç”°ä¸­'], 'äºŒæ°´é„‰': ['äºŒæ°´'], 'èŠ±å£‡é„‰': ['èŠ±å£‡'], 'å¤§æ‘é„‰': ['å¤§æ‘'] },
            'Yunlin': { 'æ–—å…­å¸‚': ['æ–—å…­'], 'æ–—å—é®': ['æ–—å—'], 'æ—å…§é„‰': ['æ—å…§'] },
            'ChiayiCity': { 'è¥¿å€': ['å˜‰ç¾©'] },
            'ChiayiCounty': { 'æ°‘é›„é„‰': ['æ°‘é›„'], 'å¤§æ—é®': ['å¤§æ—'], 'æ°´ä¸Šé„‰': ['æ°´ä¸Š', 'å—é–'] },
            'Tainan': { 'æ±å€': ['å°å—'], 'æ°¸åº·å€': ['æ°¸åº·', 'å¤§æ©‹'], 'æ–°ç‡Ÿå€': ['æ–°ç‡Ÿ'], 'å–„åŒ–å€': ['å–„åŒ–'], 'ä»å¾·å€': ['ä¿å®‰', 'ä»å¾·'], 'æ­¸ä»å€': ['æ²™å´™'] },
            'Kaohsiung': {
                'ä¸‰æ°‘å€': ['é«˜é›„'], 'å·¦ç‡Ÿå€': ['æ–°å·¦ç‡Ÿ'], 'é³³å±±å€': ['é³³å±±'], 'å²¡å±±å€': ['å²¡å±±'], 
                'æ¥ æ¢“å€': ['æ¥ æ¢“'], 'æ©‹é ­å€': ['æ©‹é ­'], 'é¼“å±±å€': ['é¼“å±±', 'ç¾è¡“é¤¨', 'å…§æƒŸ']},
            'Pingtung': { 'å±æ±å¸‚': ['å±æ±'], 'æ½®å·é®': ['æ½®å·'], 'æ‹å¯®é„‰': ['æ‹å¯®'] },
            'Yilan': { 'å®œè˜­å¸‚': ['å®œè˜­'], 'ç¾…æ±é®': ['ç¾…æ±'], 'ç¤æºªé„‰': ['ç¤æºª'], 'é ­åŸé®': ['é ­åŸ', 'é¾œå±±'], 'è˜‡æ¾³é®': ['è˜‡æ¾³', 'æ–°é¦¬'] },
            'Hualien': { 'èŠ±è“®å¸‚': ['èŠ±è“®'], 'ç‰é‡Œé®': ['ç‰é‡Œ'], 'å£½è±é„‰': ['å£½è±', 'å¿—å­¸'], 'æ–°åŸé„‰': ['æ–°åŸ'] },
            'Taitung': { 'å°æ±å¸‚': ['å°æ±'], 'æ± ä¸Šé„‰': ['æ± ä¸Š'], 'é—œå±±é®': ['é—œå±±'] }};
        const hsrMap = {
            'Taipei': { 'ä¸­æ­£å€': ['é«˜éµå°åŒ—ç«™'], 'å—æ¸¯å€': ['é«˜éµå—æ¸¯ç«™'] },
            'NewTaipei': { 'æ¿æ©‹å€': ['é«˜éµæ¿æ©‹ç«™'] },
            'Taoyuan': { 'ä¸­å£¢å€': ['é«˜éµæ¡ƒåœ’ç«™'] },
            'HsinchuCounty': { 'ç«¹åŒ—å¸‚': ['é«˜éµæ–°ç«¹ç«™'] },
            'Miaoli': { 'å¾Œé¾é®': ['é«˜éµè‹—æ —ç«™'] },
            'Taichung': { 'çƒæ—¥å€': ['é«˜éµå°ä¸­ç«™'] },
            'Changhua': { 'ç”°ä¸­é®': ['é«˜éµå½°åŒ–ç«™'] },
            'Yunlin': { 'è™å°¾é®': ['é«˜éµé›²æ—ç«™'] },
            'ChiayiCounty': { 'å¤ªä¿å¸‚': ['é«˜éµå˜‰ç¾©ç«™'] },
            'Tainan': { 'æ­¸ä»å€': ['é«˜éµå°å—ç«™'] },
            'Kaohsiung': { 'å·¦ç‡Ÿå€': ['é«˜éµå·¦ç‡Ÿç«™'] }};
        const airportMap = {
            'Taipei': { 'æ¾å±±å€': ['å°åŒ—æ¾å±±æ©Ÿå ´ (TSA)'] },
            'Taoyuan': { 'å¤§åœ’å€': ['æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)'] },
            'Taichung': { 'æ²™é¹¿å€': ['å°ä¸­åœ‹éš›æ©Ÿå ´ (RMQ)'] },
            'Kaohsiung': { 'å°æ¸¯å€': ['é«˜é›„å°æ¸¯æ©Ÿå ´ (KHH)'] },
            'Hualien': { 'æ–°åŸé„‰': ['èŠ±è“®æ©Ÿå ´ (HUN)'] },
            'Taitung': { 'å°æ±å¸‚': ['å°æ±æ©Ÿå ´ (TTT)'] },
            'Penghu': { 'æ¹–è¥¿é„‰': ['æ¾æ¹–æ©Ÿå ´ (MZG)'] },
            'Kinmen': { 'é‡‘æ¹–é®': ['é‡‘é–€æ©Ÿå ´ (KNH)'] },
            'Lienchiang': { 'å—ç«¿é„‰': ['é¦¬ç¥–å—ç«¿æ©Ÿå ´'], 'åŒ—ç«¿é„‰': ['é¦¬ç¥–åŒ—ç«¿æ©Ÿå ´'] }};
        window.onload = () => {
            initLocationWatch(); updateDistricts(); updateUsageDisplay();loadProfile();
            const key = getStoredKey(); if(key) document.getElementById('api-key-input').value = key;
            const bg = document.getElementById('bg-container');
            images.forEach((url, i) => {
                const div = document.createElement('div');
                div.className = 'bg-slide' + (i === 0 ? ' active' : '');
                div.style.backgroundImage = `url('${url}?auto=format&fit=crop&w=1200')`;
                bg.appendChild(div);
            });
            setInterval(() => {
                let slides = document.querySelectorAll('.bg-slide');
                let active = document.querySelector('.bg-slide.active');
                if(!active) return;
                let next = active.nextElementSibling || slides[0];
                active.classList.remove('active'); next.classList.add('active');
            }, 6000);
        };
function toggleApiGuide() {
    const box = document.getElementById('api-guide-box');
    // ä¿®æ­£é‚è¼¯ï¼šå¦‚æœç›®å‰æ˜¯ç©ºçš„æˆ–æ˜¯ noneï¼Œå°±é¡¯ç¤ºï¼›å¦å‰‡éš±è—
    if (box.style.display === "" || box.style.display === "none") {
        box.style.display = "block";
    } else {
        box.style.display = "none";
    }
}        function initLocationWatch() { if ("geolocation" in navigator) { navigator.geolocation.watchPosition((pos) => { userCoords.lat = pos.coords.latitude; userCoords.lng = pos.coords.longitude; if (!isNearbyMode) document.getElementById('coords-text').innerText = `ğŸ“ ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)}`; }, () => {}, { enableHighAccuracy: true }); } }
        function toggleNearbyMode() {
            isNearbyMode = !isNearbyMode; const btn = document.getElementById('location-display'); const fields = document.querySelectorAll('.nearby-toggle');
            if (isNearbyMode) { btn.classList.add('active-mode'); fields.forEach(f => f.classList.add('hide-field')); document.getElementById('mrt-section').style.display = 'none'; document.getElementById('coords-text').innerText = "ğŸ¯ æœå°‹é™„è¿‘ 1.5km å…§ç¾é£Ÿ"; }
            else { btn.classList.remove('active-mode'); fields.forEach(f => f.classList.remove('hide-field')); checkTransAvailability(); document.getElementById('coords-text').innerText = userCoords.lat ? `ğŸ“ ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)}` : "æ­£åœ¨å–å¾— GPS åº§æ¨™..."; }
        }
        function updateDistricts() { const city = document.getElementById('city').value; document.getElementById('district').innerHTML = cityData[city].map(d => `<option value="${d}">${d}</option>`).join(''); checkTransAvailability(); }
        function checkTransAvailability() {
            const city = document.getElementById('city').value;
            const transport = document.getElementById('transport').value;
            const district = document.getElementById('district').value;
            const mrtSec = document.getElementById('mrt-section');
            const mrtSel = document.getElementById('mrt-station');
            const label = document.getElementById('trans-label');
            const mainLabel = document.getElementById('transport-main-label');
            const iconMap = { none: 'ğŸš†', mrt: 'ğŸš‡', hsr: 'ğŸš„', train: 'ğŸš‚', airport: 'âœˆï¸' };
            const nameMap = { none: 'äº¤é€šåå¥½', mrt: 'äº¤é€šåå¥½', hsr: 'äº¤é€šåå¥½', train: 'äº¤é€šåå¥½', airport: 'äº¤é€šåå¥½' };
            if (mainLabel) mainLabel.innerText = `${iconMap[transport]} ${nameMap[transport]}`;
            if (transport === 'none' || isNearbyMode) { mrtSec.style.display = 'none'; return; }
            mrtSec.style.display = 'block';
            if (transport === 'mrt') {
                label.innerText = "ğŸš‡ æŒ‡å®šæ·é‹ç«™ (ä¾ç·šè·¯åˆ†é¡)";
                let linesData = (city === 'Taipei' ? mrtLinesTaipei : (city === 'NewTaipei' ? mrtLinesNewTaipei : (city === 'Taoyuan' ? mrtLinesTaoyuan : (city === 'Taichung' ? mrtLinesTaichung : (city === 'Kaohsiung' ? mrtLinesKaohsiung : null)))));
                if (district === 'å…¨å€' && linesData) {
                    let html = '<option value="">--- è«‹é¸æ“‡æ·é‹ç«™ ---</option>';
                    for (const line in linesData) { html += `<optgroup label="${line}">`; linesData[line].forEach(s => html += `<option value="${s}">${s}ç«™</option>`); html += `</optgroup>`; }
                    mrtSel.innerHTML = html;
                } else if (mrtMap[city] && mrtMap[city][district]) {
                    mrtSel.innerHTML = '<option value="">--- è«‹é¸æ“‡ ---</option>' + mrtMap[city][district].map(s => `<option value="${s}">${s}ç«™</option>`).join('');
                } else { mrtSel.innerHTML = '<option value="">è©²å€æš«ç„¡æ·é‹ç«™</option>'; }
            } else {
                const subNameMap = { hsr: 'é«˜éµ', train: 'ç«è»Š', airport: 'æ©Ÿå ´' };
                label.innerText = `${iconMap[transport]} æŒ‡å®š${subNameMap[transport]}ç«™`;
                let currentMap = (transport === 'train' ? trainMap : (transport === 'hsr' ? hsrMap : airportMap));
                if (currentMap[city]) {
                    let list = (district === 'å…¨å€' ? Object.values(currentMap[city]).flat() : (currentMap[city][district] || []));
                    list = [...new Set(list)].sort();
                    mrtSel.innerHTML = '<option value="">--- è«‹é¸æ“‡ ---</option>' + list.map(s => `<option value="${s}">${s}${s.includes('æ©Ÿå ´')?'':'ç«™'}</option>`).join('');
                } else { mrtSel.innerHTML = '<option value="">è©²å€æš«ç„¡ç«™é»</option>'; }
            }
        }  
        function getStoredKey() { return localStorage.getItem('EXPLORER_FINAL_SECURE_KEY') || ""; }
        function saveApiKey() { const k = document.getElementById('api-key-input').value.trim(); if(k) { localStorage.setItem('EXPLORER_FINAL_SECURE_KEY', k); document.getElementById('api-overlay').style.display='none'; alert("è¨­å®šæˆåŠŸï¼è«‹ç¢ºèªå·²å•Ÿç”¨ Places èˆ‡ Gemini æ¬Šé™ã€‚"); updateUsageDisplay(); } }
        function getUsageCount() { const today = new Date().toDateString(); const keyId = btoa(getStoredKey()).slice(-10); const stored = JSON.parse(localStorage.getItem('USAGE_'+keyId) || '{}'); return stored.date === today ? (stored.count || 0) : 0; }
        function updateUsageDisplay() { const count = getUsageCount(); document.getElementById('usage-text').innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${DAILY_LIMIT - count} æ¬¡`; }


      // --- 1. é¸å–®èˆ‡é¢ç‰ˆæ§åˆ¶ ---
function toggleSideMenu(show) {
    const overlay = document.getElementById('menu-overlay');
    const menu = document.getElementById('side-menu');
    
    if (show) {
        updateApiBillingDisplay(); // <--- åŠ åœ¨é€™è£¡ï¼Œæ¯æ¬¡é»ã€Œâ˜°ã€æ‰“é–‹é¸å–®æ™‚ï¼Œå®ƒå°±æœƒé‡ç®—ä¸€æ¬¡ç¾é‡‘çµ¦ä½ çœ‹
        overlay.style.display = 'block';
        setTimeout(() => menu.classList.add('active'), 10);
    } else {
        menu.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 300);
    }
}
// å¾é¸å–®é–‹å•Ÿ API è¨­å®š
function openApiFromMenu() {
    toggleSideMenu(false);
    setTimeout(() => { document.getElementById('api-overlay').style.display = 'flex'; }, 300);
}
// å¾é¸å–®é–‹å•Ÿç´€éŒ„ï¼ˆå¯å€åˆ† æœ€æ„› æˆ– å…¨éƒ¨ï¼‰
function openHistoryFromMenu(type) {
    currentFilter = type;
    toggleSideMenu(false);
    setTimeout(() => { toggleHistory(true); }, 300);
}

// ä¿®æ”¹ä¹‹å‰çš„ saveToHistoryï¼Œè®“å®ƒåœ¨ Like æ™‚è‡ªå‹•å„²å­˜
// ç¢ºä¿ç•™ä¸‹é€™æ®µåœ¨ initSwipe çš„ LIKE åˆ¤æ–·ä¸­ï¼š
// if (currentX > 120) { saveToHistory(res); ... }

// 1. å„²å­˜åˆ°æ­·å²ç´€éŒ„ (åªè¦ LIKE å°±å­˜)
function saveToHistory(res) {
    let history = JSON.parse(localStorage.getItem('TASTE_HISTORY') || '[]');
    if (!history.some(item => item.place_id === res.place_id)) {
        const record = { ...res, savedAt: new Date().toLocaleString() };
        history.unshift(record);
        if (history.length > 50) history.pop();
        localStorage.setItem('TASTE_HISTORY', JSON.stringify(history));
    }
}


// æœ€æ„›ç´€éŒ„ï¼šé»æ˜Ÿæ˜Ÿæ‰è¨˜ä½
function toggleFavorite(placeId, resData) {
    let favorites = JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]');
    const idx = favorites.findIndex(item => item.place_id === placeId);
    let isNowFav = false;

    if (idx !== -1) {
        favorites.splice(idx, 1); // å·²ç¶“å­˜åœ¨å°±ç§»é™¤ (å–æ¶ˆæ”¶è—)
    } else {
        // ä¸å­˜åœ¨å°±åŠ å…¥
        const foodCat = resData.category || document.getElementById('food').options[document.getElementById('food').selectedIndex].text;
        const newFav = { ...resData, category: foodCat, isFav: true, savedAt: new Date().toLocaleString() };
        favorites.unshift(newFav);
        isNowFav = true;
    }
    localStorage.setItem('TASTE_FAVORITES', JSON.stringify(favorites));

    // åŒæ­¥æ›´æ–°ç•¶å‰å¡ç‰‡ä¸Šçš„æ˜Ÿæ˜Ÿé¡è‰²
    const star = document.getElementById(`star-${placeId}`);
    if (star) star.classList.toggle('active', isNowFav);
    
    // å¦‚æœæ­£åœ¨é¢æ¿ç•«é¢ï¼Œå³æ™‚åˆ·æ–°
    if (document.getElementById('history-overlay').style.display === 'flex') {
        renderHistoryList(currentFilter);
    }
}

// æ¸²æŸ“æ¸…å–® (å¢åŠ éæ¿¾åŠŸèƒ½)
let currentFilter = 'all'; // 'all' æˆ– 'fav'


   let typingTimer = null;

function runTypingEffect() {
    const textElem = document.getElementById('loader-text');
    const texts = [
        "æ­£åœ¨åŒæ­¥æ‚¨çš„åœ°ç†åº§æ¨™...",
        "æ­£åœ¨æŒ–æ˜å··å¼„ä¸­çš„éš±è—ç¾å‘³...",
        "æ­£åœ¨æŒ‘é¸èƒ½é©šè‰·æ‚¨å‘³è•¾çš„é©šå–œ...",
        "æ­£åœ¨ç‚ºæ‚¨ç­–åŠƒå°ˆå±¬çš„ç¾å‘³ææ¡ˆ..."
    ];
    
    let i = 0;
    
    // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
    if (loaderInterval) clearInterval(loaderInterval);
    if (typingTimer) clearInterval(typingTimer);

    function typeChar(text) {
        textElem.innerText = "";
        let charIndex = 0;
        if (typingTimer) clearInterval(typingTimer);
        typingTimer = setInterval(() => {
            if (charIndex < text.length) {
                textElem.innerText += text.charAt(charIndex);
                charIndex++;
            } else {
                clearInterval(typingTimer);
            }
        }, 50); // æ‰“å­—é€Ÿåº¦
    }

    // ç«‹å³åŸ·è¡Œç¬¬ä¸€æ¬¡
    typeChar(texts[i]);

    // æ¯ 4 ç§’åˆ‡æ›ä¸‹ä¸€å¥
    loaderInterval = setInterval(() => {
        i = (i + 1) % texts.length;
        typeChar(texts[i]);
    }, 4000);
}
        
       
async function handleSearchClick() {
    const apiKey = getStoredKey();
    if (!apiKey) { document.getElementById('api-overlay').style.display = 'flex'; return; }
    
    // 1. é©—è­‰äº¤é€šå·¥å…·èˆ‡ç¸£å¸‚åŒ¹é…é‚è¼¯
    if (!isNearbyMode) {
        const cityKey = document.getElementById('city').value;
        const cityName = document.getElementById('city').options[document.getElementById('city').selectedIndex].text;
        const transport = document.getElementById('transport').value;
        const hasMRT = ['Taipei', 'NewTaipei', 'Taoyuan', 'Taichung', 'Kaohsiung'];
        const hasHSR = ['Taipei', 'NewTaipei', 'Taoyuan', 'HsinchuCounty', 'Miaoli', 'Taichung', 'Changhua', 'Yunlin', 'ChiayiCounty', 'Tainan', 'Kaohsiung'];
        const hasAirport = ['Taipei', 'Taoyuan', 'Taichung', 'Tainan', 'Kaohsiung', 'ChiayiCounty', 'Hualien', 'Taitung', 'Penghu', 'Kinmen', 'Lienchiang'];
        
        if (transport === 'mrt' && !hasMRT.includes(cityKey)) { alert(`âš ï¸ ${cityName} ç›®å‰æ²’æœ‰æ·é‹ã€‚`); return; }
        if (transport === 'hsr' && !hasHSR.includes(cityKey)) { alert(`âš ï¸ ${cityName} ç›®å‰æ²’æœ‰é«˜éµã€‚`); return; }
        if (transport === 'airport' && !hasAirport.includes(cityKey)) { alert(`âš ï¸ ${cityName} ç›®å‰æ²’æœ‰æ©Ÿå ´ã€‚`); return; }
    }

    // 2. å°è£æœå°‹æ¢ä»¶
    const config = {
        city: document.getElementById('city').value,
        cityName: document.getElementById('city').options[document.getElementById('city').selectedIndex].text,
        district: document.getElementById('district').value,
        transport: document.getElementById('transport').value,
        food: document.getElementById('food').options[document.getElementById('food').selectedIndex].text,
        people: document.getElementById('people') ? document.getElementById('people').value : "1~2 äºº",
        purpose: document.getElementById('purpose').options[document.getElementById('purpose').selectedIndex].text,
        budget: document.getElementById('budget').options[document.getElementById('budget').selectedIndex].text,
        station: document.getElementById('mrt-station').value,
        isHidden: document.getElementById('btn-hidden').classList.contains('selected'),
        isOpenOnly: document.getElementById('btn-open').classList.contains('selected')
    };

    if (getUsageCount() >= DAILY_LIMIT) { alert("ğŸš« ä»Šæ—¥æ¢ç´¢æ¬¡æ•¸å·²æ»¿ã€‚"); return; }
    startSearch(apiKey, config);
}
     
      
        async function startSearch(apiKey, config) {
    const loader = document.getElementById('loader');
    const btn = document.getElementById('search-btn');
    
    // 1. å•Ÿå‹• UI è¼‰å…¥ç‹€æ…‹
    loader.style.display = 'flex';
    runTypingEffect(); // å•Ÿå‹•æ‰“å­—æ©Ÿå‹•æ•ˆ
    btn.disabled = true;

    try {
        // 2. ç¬¬ä¸€éšæ®µï¼šç²å– Google åœ°åœ–åŸå§‹æ•¸æ“š
        const rawPlaces = await fetchRealPlaces(apiKey, config);
        
        if (!rawPlaces || rawPlaces.length === 0) {
            throw new Error("åœ¨è©²å€åŸŸæ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åº—å®¶ï¼Œè«‹æ”¾å¯¬æœå°‹æ¢ä»¶ã€‚");
        }

        // 3. ç¬¬äºŒéšæ®µï¼šé€²è¡Œ AI é‘‘å®šèˆ‡ç†ç”±ç”Ÿæˆ (é€™è£¡æœƒç”¨åˆ° Gemini)
        const finalRecommendations = await getAiRanking(apiKey, config, rawPlaces);

        // 4. ç¬¬ä¸‰éšæ®µï¼šæ¸²æŸ“çµæœ
        if (finalRecommendations && finalRecommendations.length > 0) {
            incrementUsage(); // é€™è£¡æœƒé€£å‹•æ›´æ–°ä½ å‰›åŠ çš„ã€ŒAPI æµé‡ç›£æ§ã€
            keptRestaurants = []; 
            isFinalOne = false;

            // åŠ å…¥é£Ÿç‰©åˆ†é¡æ¨™ç±¤ï¼Œæ–¹ä¾¿æ­·å²ç´€éŒ„åˆ†é¡
            const foodCategory = config.food; 
            const taggedRecommendations = finalRecommendations.map(res => ({
                ...res,
                category: foodCategory 
            }));

            renderCards(taggedRecommendations);
        }
    } catch (e) {
        console.error("æ¢ç´¢éç¨‹ç™¼ç”ŸéŒ¯èª¤:", e);
        let errorMsg = e.message;
        
        // ç²¾æº–éŒ¯èª¤å¼•å°
        if (errorMsg.includes("Places API")) {
            errorMsg = "âŒ åœ°åœ–æ¬Šé™æœªé–‹å•Ÿï¼\nè«‹é€²å…¥ Google Cloud æ§åˆ¶å°å•Ÿç”¨ã€ŒPlaces API (New)ã€ï¼Œä¸¦ç¢ºèªå·²ç¶å®šä¿¡ç”¨å¡ï¼ˆçµç®—å¸³æˆ¶ï¼‰ã€‚";
        } else if (errorMsg.includes("Generative Language") || errorMsg.includes("Gemini")) {
            errorMsg = "âŒ AI æ¬Šé™æœªé–‹å•Ÿï¼\nè«‹ç¢ºèªä½ çš„ API Key å·²å•Ÿç”¨ã€ŒGenerative Language APIã€ã€‚";
        } else if (errorMsg.includes("Candidates")) {
            errorMsg = "âŒ AI ç„¡æ³•ç”¢ç”Ÿæ¨è–¦ï¼Œå¯èƒ½æ˜¯å› ç‚ºå€åŸŸå…§åº—å®¶è³‡è¨Šä¸è¶³æˆ– API Key é™åˆ¶ã€‚";
        }
        
        alert(errorMsg);
    } finally {
        // 5. åœæ­¢å‹•ç•«ä¸¦æ¢å¾©æŒ‰éˆ•
        if (loaderInterval) clearInterval(loaderInterval);
        if (typingTimer) clearInterval(typingTimer);
        
        loader.style.display = 'none';
        btn.disabled = false;
    }
}
        async function fetchRealPlaces(apiKey, cfg) {
                const userCardCount = parseInt(localStorage.getItem('EXPLORER_CARD_COUNT') || "10");
    let qFood = cfg.food.split(' / ')[0].replace(" (ä»€éº¼éƒ½æƒ³åƒ)", "").replace("å…¨éƒ¨", "ç¾é£Ÿé¤å»³");
    let qDist = (cfg.district === "å…¨å€") ? "" : cfg.district;
    let query = isNearbyMode ? qFood : `${cfg.cityName} ${qDist} ${qFood}`;

    const requestBody = {
        textQuery: query,
        maxResultCount:userCardCount,
        languageCode: "zh-TW",
        regionCode: "TW",
        openNow: cfg.isOpenOnly
    };

    if (userCoords.lat && userCoords.lng) {
        // ä¿®æ­£ï¼šGoogle API searchText ä¸æ”¯æ´ locationRestriction ç”¨ circle
        // å¿…é ˆçµ±ä¸€ä½¿ç”¨ locationBias æ‰èƒ½æ­£ç¢ºåŸ·è¡Œåœ“å½¢åŠå¾‘æœå°‹
        requestBody.locationBias = {
            circle: { 
                center: { latitude: userCoords.lat, longitude: userCoords.lng }, 
                radius: isNearbyMode ? 1500.0 : 5000.0 
            }
        };
    }

    const response = await fetch('https://places.googleapis.com/v1/places:searchText', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Goog-Api-Key': apiKey,
            'X-Goog-FieldMask': 'places.displayName,places.rating,places.userRatingCount,places.priceLevel,places.id,places.location,places.formattedAddress,places.photos,places.regularOpeningHours'
        },
        body: JSON.stringify(requestBody)
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message); // å¢åŠ éŒ¯èª¤åµæ¸¬
    return data.places || [];
}
// --- ä¿®æ­£å¾Œçš„ç‰©ç†è·é›¢è¨ˆç®—å‡½å¼ ---
function calculateDistance(lat1, lon1, lat2, lon2) {
    if (!lat1 || !lon1 || !lat2 || !lon2) return "æœªçŸ¥è·é›¢";
    const R = 6371; 
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    
    let d = R * c * 1.4; 
    
    if (d < 1) {
        let meters = (d * 1000).toFixed(0);
        meters = Math.ceil(meters / 10) * 10;
        return `ğŸš¶ æ­¥è¡Œç´„ ${meters}m`;
    } else {
        return `ğŸš¶ æ­¥è¡Œç´„ ${d.toFixed(1)}km`;
    }
} // <--- è£œä¸Šé€™å€‹æ‹¬è™Ÿï¼Œè§£æ±º "not defined" çš„é—œéµ
    



async function getAiRanking(apiKey, cfg, rawPlaces) {
    // ç¶­æŒæ‚¨è¦æ±‚çš„ 2.5 ç‰ˆæœ¬ï¼Œä¸åšä»»ä½•ä¿®æ”¹
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

    // --- æ­¥é©Ÿ 1ï¼šæ•¸æ“šæº–å‚™èˆ‡ç²¾æº–è·é›¢è¨ˆç®— (å–ä»£ Routes API) ---
    const detailedList = rawPlaces.map(p => {
        // ä½¿ç”¨ JavaScript åœ¨æœ¬åœ°è¨ˆç®—çµ•å°ç²¾æº–çš„ç‰©ç†è·é›¢
        let distStr = calculateDistance(userCoords.lat, userCoords.lng, p.location.latitude, p.location.longitude);
        
        return {
            name: p.displayName.text,
            rating: p.rating || "N/A",
            reviews: p.userRatingCount || 0,
            address: p.formattedAddress,
            place_id: p.id,
            price_level: p.priceLevel,
            dist_val: distStr, 
            weekly_hours: p.regularOpeningHours?.weekdayDescriptions || ["æœªæä¾›å®Œæ•´ç‡Ÿæ¥­æ™‚é–“"]
        };
    });

    // --- æ­¥é©Ÿ 2ï¼šç”ŸæˆæŒ‡ä»¤ (éš±è—ç‰ˆèˆ‡ç‡Ÿæ¥­ä¸­é‚è¼¯) ---
    const hiddenGemInstruction = cfg.isHidden ? 
        `ã€ä»»å‹™ï¼šéš±è—ç‰ˆæ¨¡å¼ã€‘
        1. å„ªå…ˆæŒ‘é¸è©•è«–æ•¸è¼ƒå°‘ï¼ˆå¦‚å°‘æ–¼ 300 å‰‡ï¼‰ä½†è©•åˆ†æ¥µé«˜ï¼ˆå¦‚ 4.3 ä»¥ä¸Šï¼‰çš„å°åº—ã€‚
        2. å°‹æ‰¾ä½æ–¼å··å¼„å…§ã€æˆ–æ˜¯æè¿°ä¸­æåˆ°æ˜¯ç§å»šã€åœ¨åœ°äººæ‰çŸ¥é“çš„é©šå–œç¾å‘³ã€‚
        3. åš´æ ¼é¿é–‹è·¨åœ‹é€£é–åº—èˆ‡ç™¾è²¨å¤§å“ç‰Œã€‚` : 
        `ã€ä»»å‹™ï¼šå„ªè³ªååº—æ¨¡å¼ã€‘æŒ‘é¸ç•¶åœ°è©•åƒ¹æœ€ç©©å®šã€çŸ¥ååº¦é«˜ä¸”çµ•å°ä¸è¸©é›·çš„é«˜å“è³ªé¤å»³ã€‚`;
    
    const openNowInstruction = cfg.isOpenOnly ? 
        `ã€é‡è¦éæ¿¾æ¢ä»¶ã€‘ç”¨æˆ¶è¦æ±‚ã€Œç¾åœ¨ç‡Ÿæ¥­ä¸­ã€ï¼Œè«‹å‹™å¿…æª¢æŸ¥ç‡Ÿæ¥­æ™‚é–“æ•¸æ“šï¼Œåƒ…å›å‚³ç›®å‰æ­£åœ¨ç‡Ÿæ¥­å…§çš„åº—å®¶ã€‚` : "";

    // --- æ­¥é©Ÿ 3ï¼šæ§‹å»ºçµ¦ AI çš„æœ€çµ‚ Prompt ---
    const prompt = `ä½ æ˜¯é ‚ç´šç¾é£Ÿé‘‘å®šå®¶ã€‚è«‹å¾åå–®æŒ‘é¸ 6 å®¶æœ€ç¬¦åˆã€Œ${cfg.food} / ${cfg.purpose} / é ç®— ${cfg.budget}ã€çš„é¤å»³ã€‚

    æŒ‡ä»¤ï¼š${hiddenGemInstruction}
    ${openNowInstruction}

    åå–®æ•¸æ“šï¼š${JSON.stringify(detailedList)}

    ã€å›å‚³è¦ç¯„ã€‘ï¼š
    è«‹åš´æ ¼å›å‚³ä¸€å€‹ JSON é™£åˆ—ï¼Œæ¯å€‹ç‰©ä»¶å¿…é ˆç²¾æº–åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼Œä¸å¯ç¼ºæ¼ï¼š
    - name: é¤å»³åç¨±
    - rating: è©•åˆ† (æ•¸å­—)
    - review_count: è©•è«–æ•¸ (æ•¸å­—)
    - distance: è«‹ç›´æ¥æ¡ç”¨æˆ‘æä¾›çš„ real_distance å…§å®¹
    - price: æ¶ˆè²»å€é–“ (ä¾ price_level è½‰æ›ç‚ºå°å¹£ï¼Œæ ¼å¼å¦‚ "$300 ~ $600")
    - opening_hours: ç‡Ÿæ¥­æ™‚é–“ (è«‹å°‡ weekly_hours æ•´ç†æˆã€Œé€±ä¸€è‡³é€±äº” 11:30â€“21:00 (é€±å¹¾å…¬ä¼‘)ã€é€™ç¨®æ¸…æ™°æ ¼å¼)
    - address: é¤å»³è©³ç´°åœ°å€
    - signature: è©²åº—å¿…é»çš„ 1-2 æ¨£æ‹›ç‰Œèœè‰²
    - review_summary: æ¿ƒç¸®ç¶²è·¯è©•åƒ¹æœ€ç²¾é—¢çš„ä¸€å¥è©•è«–
    - reason: å°ˆæ¥­çš„æ¨è–¦ç†ç”±
    - place_id: åŸå§‹åå–®ä¸­çš„ place_id`;

    // --- æ­¥é©Ÿ 4ï¼šå‘¼å« Gemini AI (åŒ…å«éŒ¯èª¤æ””æˆª) ---
    const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { 
                response_mime_type: "application/json", 
                temperature: 0.2 
            }
        })
    });

    const result = await response.json();
    
    if (result.error) {
        throw new Error(`AI æœå‹™éŒ¯èª¤: ${result.error.message}`);
    }
    if (!result.candidates || !result.candidates[0].content.parts) {
        throw new Error("AI ç„¡æ³•ç”¢ç”Ÿå»ºè­°ï¼Œè«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºé–‹å•Ÿ Generative Language æ¬Šé™ã€‚");
    }

    const recommendations = JSON.parse(result.candidates[0].content.parts[0].text);
    
    // --- æ­¥é©Ÿ 5ï¼šå›å‚³çµæœ (ä¾ç…§æŒ‡ç¤ºå¾¹åº•ä¸ä½¿ç”¨ç…§ç‰‡ï¼Œä½¿ç”¨ç²¾æº–åœ°åœ–é€£çµ) ---
    return recommendations.map(res => ({
        ...res,
        photo_url: null, // ä¿®æ­£ï¼šå¾¹åº•ä¸ä½¿ç”¨ç…§ç‰‡
        // ä¿®æ­£ï¼šä½¿ç”¨ Place ID é€²è¡Œ 100% ç²¾ç¢ºé€£çµ
        map_query: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(res.name)}&query_place_id=${res.place_id}`
    }));
}
     
        // --- ä¿®æ”¹å¾Œçš„å¡ç‰‡æ¸²æŸ“å‡½å¼ ---
function renderCards(restaurants) {
    document.getElementById('main-ui').classList.add('blur-mode');
    const stack = document.getElementById('card-stack'); 
    stack.innerHTML = ''; 
    document.getElementById('swiper-overlay').style.display = 'flex';
    isFinalOne = (restaurants.length === 1);

    restaurants.forEach((res) => {
        // 1. ã€çœ‹éå°±è¨˜ã€‘è‡ªå‹•å­˜å…¥ç¨ç«‹æ­·å²è³‡æ–™åº«
        saveToHistory(res);

        // 2. æª¢æŸ¥æœ€æ„›ç‹€æ…‹ (å¾ç¨ç«‹çš„æœ€æ„›è³‡æ–™åº«æŠ“å–)
        const favorites = JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]');
        const isAlreadyFav = favorites.some(item => item.place_id === res.place_id);

        const wrapper = document.createElement('div'); 
        wrapper.className = 'swipe-card-wrapper';
        const card = document.createElement('div'); // <-- ä¿®æ­£ï¼šç¢ºä¿å®£å‘Š card
        card.className = 'swipe-card';
        
        // 3. å®Œç¾é‚„åŸä½ åŸæœ¬çš„æ‰€æœ‰è¯éº—è¦–è¦ºæ¨™ç±¤èˆ‡å…§å®¹
        card.innerHTML = `
            <div class="swipe-hints"><div class="hint-item">â† NOPE</div><div class="hint-item">LIKE â†’</div></div>
            <div class="swipe-label label-like">LIKE</div>
            <div class="swipe-label label-nope">NOPE</div>
            <div class="label-chosen">ğŸ† æœ€çµ‚é¦–é¸</div>

            <div class="card-content">
                <!-- æ˜Ÿæ˜Ÿèˆ‡åº—å -->
                <h2 class="card-title" style="display: flex; align-items: flex-start; gap: 8px;">
                    <span class="star-btn ${isAlreadyFav ? 'active' : ''}" 
                          id="star-${res.place_id}" 
                          style="flex-shrink: 0; margin-top: 2px; font-size: 1.8rem; cursor: pointer;">â˜…</span>
                    <span style="flex: 1; line-height: 1.2;">${res.name}</span>
                </h2>
                
                <!-- ä½ çš„ä¸‰è‰²ç²¾ç·»æ¨™ç±¤ Pills -->
                <div class="info-bar">
                    <div class="pill-yellow">â­ googlè©•åˆ† ${res.rating}</div>
                    <div class="pill-orange">ğŸ“ ç›´ç·šè·é›¢ ${res.distance}</div>
                    <div class="pill-price">ğŸ’° é ä¼°åƒ¹ä½ ${res.price}</div>
                </div>
                
                <!-- ä½ çš„è©³ç´°è³‡è¨Šå€å¡Š -->
                <div class="detail-section">
                    <div class="detail-label">ğŸ•’ ç‡Ÿæ¥­æ™‚é–“</div>
                    <div class="detail-text">${res.opening_hours}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ğŸ  é¤å»³åœ°å€</div>
                    <div class="detail-text">${res.address}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">ğŸ”¥ å¿…é»æ‹›ç‰Œ</div>
                    <div class="detail-text">${res.signature}</div>
                </div>
                
                <!-- å¼•è¨€èˆ‡æ¨è–¦åŸå›  -->
                <div class="summary-quote">"${res.review_summary}"</div>

                <div class="recommendation-box">
                    <div class="detail-label">ğŸ’¡ æ¨è–¦åŸå› </div>
                    <div style="color:var(--accent-yellow); font-size:1.05rem; line-height:1.7; font-weight:500;">${res.reason}</div>
                </div>

                <a class="card-map-btn" href="${res.map_query}" target="_blank" style="margin-top:15px; height:55px; border-radius:16px;">ğŸ—ºï¸ æ‰“é–‹åœ°åœ–æŸ¥çœ‹è©³æƒ…</a>
            </div>
        `;

        // 4. äº‹ä»¶ç¶å®šï¼šè™•ç†æ˜Ÿæ˜Ÿé»æ“Š
        const starBtn = card.querySelector('.star-btn');
        const handleStarAction = (e) => {
            e.preventDefault();
            e.stopPropagation(); // é˜»æ­¢æ»‘å‹•å¡ç‰‡
            toggleFavorite(res.place_id, res); 
        };
        starBtn.addEventListener('click', handleStarAction);
        starBtn.addEventListener('touchstart', handleStarAction);
        
        wrapper.appendChild(card); 
        stack.insertBefore(wrapper, stack.firstChild); 
        initSwipe(card, wrapper, res);
    });
    
    const closeBtn = document.createElement('button'); 
    closeBtn.className = 'close-swiper'; 
    closeBtn.innerText = 'â† è¿”å›ä¿®æ”¹'; 
    closeBtn.onclick = resetUI; 
    stack.appendChild(closeBtn);
}
        
// --- ä¿®æ”¹å¾Œçš„æ»‘å‹•é‚è¼¯ (ä¿®æ­£è“‹ç« æ™‚ LIKE æ¶ˆå¤±) ---
function initSwipe(card, wrapper, res) {
    let startX = 0, startY = 0, currentX = 0, isScrolling = false;

    card.addEventListener('touchstart', e => {
        // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘æª¢æŸ¥æ‘¸åˆ°çš„ç›®æ¨™æ˜¯ä¸æ˜¯æ˜Ÿæ˜Ÿæˆ–åœ°åœ–æŒ‰éˆ• ---
        if (e.target.closest('.star-btn') || e.target.closest('.card-map-btn')) {
            return; // å¦‚æœæ˜¯æ˜Ÿæ˜Ÿæˆ–æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œæ»‘å‹•é‚è¼¯
        }

        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        card.style.transition = 'none';
        isScrolling = false;
    }, { passive: true });

    card.addEventListener('touchmove', e => {
        currentX = e.touches[0].clientX - startX;
        let currentY = e.touches[0].clientY - startY;

        // åµæ¸¬æ˜¯å¦ç‚ºä¸Šä¸‹æ»¾å‹•é é¢
        if (!isScrolling && Math.abs(currentY) > Math.abs(currentX)) isScrolling = true;

        if (!isScrolling) {
            if (e.cancelable) e.preventDefault(); 
            let rotation = currentX / 15;
            card.style.transform = `translateX(${currentX}px) rotate(${rotation}deg)`;
            
            // --- æ ¸å¿ƒï¼šæ ¹æ“šæ»‘å‹•æ–¹å‘é¡¯ç¤ºå°æ‡‰æ¨™ç±¤ ---
            if (currentX > 50) { 
                // ã€å‘å³æ»‘ã€‘é¡¯ç¤º LIKE æ¨™ç±¤ (æ­¤æ™‚æ¨™ç±¤æ‡‰åœ¨å·¦ä¸Šæ–¹ï¼ŒCSS å·²è¨­ left: 25px)
                card.querySelector('.label-like').style.opacity = Math.min(currentX / 150, 1);
                card.querySelector('.label-nope').style.opacity = 0;
            } else if (currentX < -50) { 
                // ã€å‘å·¦æ»‘ã€‘é¡¯ç¤º NOPE æ¨™ç±¤ (æ­¤æ™‚æ¨™ç±¤æ‡‰åœ¨å³ä¸Šæ–¹ï¼ŒCSS å·²è¨­ right: 25px)
                card.querySelector('.label-nope').style.opacity = Math.min(Math.abs(currentX) / 150, 1);
                card.querySelector('.label-like').style.opacity = 0;
            } else {
                // å›åˆ°ä¸­å¿ƒé»ï¼Œå…¨éƒ¨éš±è—
                card.querySelector('.label-like').style.opacity = 0;
                card.querySelector('.label-nope').style.opacity = 0;
            }
        }
    }, { passive: false });

    card.addEventListener('touchend', () => {
        if (isScrolling) return;
        card.style.transition = '0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        
        if (currentX > 120) { // LIKE ç¢ºå®š
            saveToHistory(res);
            if (isFinalOne) {
                card.style.transform = `scale(1.02) rotate(0deg)`;
                card.classList.add('stamped');
                card.querySelector('.label-chosen').classList.add('active');
                card.querySelector('.label-like').style.opacity = 0; 
            } else {
                keptRestaurants.push(res);
                card.style.transform = `translateX(1000px) rotate(30deg)`;
                card.style.opacity = '0';
                checkStackEnd(wrapper);
            }
        } else if (currentX < -120) { // NOPE ç¢ºå®š
            card.style.transform = `translateX(-1000px) rotate(-30deg)`;
            card.style.opacity = '0';
            checkStackEnd(wrapper);
        } else {
            // å½ˆå›åŸä½
            card.style.transform = '';
            card.querySelector('.label-like').style.opacity = 0;
            card.querySelector('.label-nope').style.opacity = 0;
        }
        currentX = 0;
    });
}
         function checkStackEnd(wrapper) {
        setTimeout(() => {
            wrapper.remove();
            const cardsLeft = document.querySelectorAll('.swipe-card-wrapper').length;
            if (cardsLeft === 0) {
                if (keptRestaurants.length > 0) {
                    renderCards([...keptRestaurants]);
                    keptRestaurants = [];
                } else {
                    // é¡¯ç¤ºã€Œæ²’æœ‰å–œæ­¡åº—å®¶ã€å½ˆçª—
                    document.getElementById('no-match-modal').style.display = 'flex';
                    const closeBtn = document.querySelector('.close-swiper');
                    if (closeBtn) closeBtn.style.display = 'none';
                }
            }
        }, 400);
    }

  
   
// ==========================================
    // æ ¸å¿ƒï¼šè³‡æ–™åº«åˆ†å®¶é‚è¼¯ (æ­·å²èˆ‡æœ€æ„›å®Œå…¨åˆ†é–‹)
    // ==========================================

    // 1. è‡ªå‹•å­˜å…¥æ­·å² (çœ‹éå°±è¨˜)
    function saveToHistory(res) {
        let history = JSON.parse(localStorage.getItem('TASTE_HISTORY') || '[]');
        if (!history.some(item => item.place_id === res.place_id)) {
            const record = { ...res, savedAt: new Date().toLocaleString() };
            history.unshift(record);
            if (history.length > 50) history.pop();
            localStorage.setItem('TASTE_HISTORY', JSON.stringify(history));
        }
    }

    // 2. åˆ‡æ›æœ€æ„›ç‹€æ…‹ (ç¨ç«‹å­˜å…¥ TASTE_FAVORITES)
    function toggleFavorite(placeId, resData) {
        let favorites = JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]');
        const idx = favorites.findIndex(item => item.place_id === placeId);
        let isNowFav = false;

        if (idx !== -1) {
            favorites.splice(idx, 1); // ç§»é™¤æ”¶è—
        } else {
            // æ–°å¢æ”¶è—ï¼Œä¸¦è£œä¸Šæœå°‹æ™‚çš„é£Ÿç‰©é¡åˆ¥
            const foodCat = resData.category || document.getElementById('food').options[document.getElementById('food').selectedIndex].text;
            const newFav = { ...resData, category: foodCat, isFav: true, savedAt: new Date().toLocaleString() };
            favorites.unshift(newFav);
            isNowFav = true;
        }
        localStorage.setItem('TASTE_FAVORITES', JSON.stringify(favorites));

        // åŒæ­¥æ›´æ–°ç•¶å‰å¡ç‰‡æ˜Ÿæ˜Ÿ
        const star = document.getElementById(`star-${placeId}`);
        if (star) star.classList.toggle('active', isNowFav);
        
        // å¦‚æœæ­£åœ¨æœ€æ„›ä»‹é¢ï¼Œå³æ™‚é‡æ–°æ¸²æŸ“
        if (document.getElementById('history-overlay').style.display === 'flex') {
            renderHistoryList(currentFilter);
        }
    }

    // 3. æ¸²æŸ“æ­·å²/æœ€æ„›æ¸…å–® (å«åˆ†é¡åŠŸèƒ½)
    function renderHistoryList(filter = 'all') {
        currentFilter = filter;
        const container = document.getElementById('history-list');
        const clearBtn = document.getElementById('clear-all-btn');
        
        // æ ¹æ“šéæ¿¾æ¢ä»¶é¸æ“‡è³‡æ–™åº«
        let data = (filter === 'fav') 
            ? JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]') 
            : JSON.parse(localStorage.getItem('TASTE_HISTORY') || '[]');

        document.getElementById('history-title').innerText = (filter === 'fav') ? 'â­ æˆ‘çš„æœ€æ„›' : 'ğŸ•’ æ¢ç´¢æ­·å²';
        
        // åªæœ‰åœ¨æ­·å²ç´€éŒ„æ‰é¡¯ç¤ºã€Œå…¨éƒ¨åˆªé™¤ã€
        if (clearBtn) clearBtn.style.display = (filter === 'fav') ? 'none' : 'block';

        if (data.length === 0) {
            container.innerHTML = `<div style="text-align:center; margin-top:100px; color:#666;">å°šæœªæœ‰ç´€éŒ„</div>`;
            return;
        }

        if (filter === 'fav') {
            // æœ€æ„›æ¨¡å¼ï¼šæŒ‰ã€Œé¡åˆ¥ã€åˆ†çµ„é¡¯ç¤º
            const groups = data.reduce((acc, item) => {
                const cat = item.category || "ä¸€èˆ¬æ¢ç´¢";
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            let html = '';
            for (const cat in groups) {
                html += `
                    <div style="margin-top:15px;">
                        <div style="color:var(--primary-orange); font-size:0.85rem; font-weight:800; padding:4px 10px; background:rgba(255,102,0,0.15); border-radius:6px; display:inline-block; margin-bottom:10px;">${cat}</div>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            ${groups[cat].map(res => renderItemHTML(res, filter)).join('')}
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        } else {
            // æ­·å²æ¨¡å¼ï¼šç›´æ¥æ¸…å–®é¡¯ç¤º
            container.innerHTML = data.map(res => renderItemHTML(res, filter)).join('');
        }
    }

    // 4. ç”¢ç”Ÿå–®ç­†ç´€éŒ„çš„ HTML (é‚„åŸ 100% è¦–è¦ºç´°ç¯€)
    function renderItemHTML(res, filter) {
    // æª¢æŸ¥æ˜¯å¦æœ‰ç­†è¨˜
    const favs = JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]');
    const isFav = favs.some(i => i.place_id === res.place_id);
    const hasNote = favs.find(i => i.place_id === res.place_id && (i.userNote || i.userImage));

    return `
        <div class="swipe-item-wrapper" id="wrapper-${res.place_id}">
            <!-- åº•å±¤åˆªé™¤æŒ‰éˆ• -->
            <div class="swipe-delete-action" onclick="deleteSingleRecord('${res.place_id}', '${filter}')">åˆªé™¤</div>
            
            <!-- ä¸Šå±¤å…§å®¹ -->
            <div class="swipe-item-content" 
                 id="content-${res.place_id}"
                 ontouchstart="handleListTouchStart(event, '${res.place_id}')"
                 ontouchmove="handleListTouchMove(event, '${res.place_id}')"
                 ontouchend="handleListTouchEnd(event, '${res.place_id}')">
                
                <div style="flex:1; padding-right:10px;" onclick="${filter === 'fav' ? `openNoteEditor('${res.place_id}')` : ''}">
                    <div style="font-weight:bold; color:#fff; font-size:1.1rem; line-height:1.2;">
                        ${res.name} ${hasNote ? 'ğŸ“' : ''}
                    </div>
                    <div style="font-size:0.75rem; color:#aaa; margin-top:4px;">${res.address}</div>
                </div>

                <div style="display:flex; align-items:center; gap:10px;">
                    <a href="${res.map_query}" target="_blank" style="background:var(--primary-orange); color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:0.8rem; font-weight:bold;">åœ°åœ–</a>
                    <!-- åŸæœ¬çš„ âœ• æŒ‰éˆ•å·²ç§»é™¤ï¼Œæ”¹ç”±å·¦æ»‘è§¸ç™¼ -->
                </div>
            </div>
        </div>`;
}
    // 5. ç¨ç«‹åˆªé™¤é‚è¼¯
    function deleteSingleRecord(placeId, filter) {
    const dbName = (filter === 'fav') ? 'TASTE_FAVORITES' : 'TASTE_HISTORY';
    
    // é€™è£¡ä¸ä½¿ç”¨ confirm å½ˆçª—ï¼Œè®“åˆªé™¤åƒè˜‹æœä¸€æ¨£é †æš¢ï¼Œæˆ–è€…ä½ å¯ä»¥ä¿ç•™
    let list = JSON.parse(localStorage.getItem(dbName) || '[]');
    list = list.filter(item => item.place_id !== placeId);
    localStorage.setItem(dbName, JSON.stringify(list));
    
    activeSwipeId = null; // é‡ç½®æ»‘å‹•ç‹€æ…‹
    renderHistoryList(filter); // é‡æ–°æ¸²æŸ“æ¸…å–®
}

    // 6. ä¸€éµæ¸…ç©º (åƒ…é™æ­·å²)
    function clearAllHistory() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ¢ç´¢æ­·å²ï¼Ÿ")) {
            localStorage.removeItem('TASTE_HISTORY');
            renderHistoryList('all');
        }
    }

    // ==========================================
    // å€‹äººè³‡æ–™ã€ç­‰ç´šèˆ‡ UI è¼”åŠ©åŠŸèƒ½
    // ==========================================

    function toggleHistory(show) {
        const overlay = document.getElementById('history-overlay');
        if (show) { overlay.style.display = 'flex'; renderHistoryList(currentFilter); }
        else overlay.style.display = 'none';
    }

    function loadProfile() {
        const name = localStorage.getItem('U_NAME') || "ç¾é£Ÿæ¢ç´¢è€…";
        const avatar = localStorage.getItem('U_AVATAR') || "ğŸ‘¤";
        const bgColor = localStorage.getItem('U_BG_COLOR') || "#FF6600";
        const total = parseInt(localStorage.getItem('TOTAL_SEARCHES') || '0');

        document.getElementById('user-name-display').innerText = name;
        document.getElementById('user-avatar-display').innerText = avatar;
        const circle = document.getElementById('user-avatar-display');
        circle.style.background = bgColor;
        circle.style.boxShadow = `0 0 20px ${bgColor}44`;

        const titles = ["åˆç´šåƒè²¨", "å··å¼„è€é¥•", "ç¾é£Ÿè©•è«–å®¶", "è³‡æ·±é‘‘å®šå¸«", "å‚³èªªç´šé£Ÿç¥"];
        let idx = Math.min(Math.floor(total / 10), titles.length - 1);
        document.getElementById('user-level-display').innerText = `ç­‰ç´šï¼š${titles[idx]} (${total}æ¬¡)`;
    }

    function openEditProfile() {
        document.getElementById('edit-name').value = localStorage.getItem('U_NAME') || "ç¾é£Ÿæ¢ç´¢è€…";
        document.getElementById('edit-avatar').value = localStorage.getItem('U_AVATAR') || "ğŸ‘¤";
        document.getElementById('edit-bg-color').value = localStorage.getItem('U_BG_COLOR') || "#FF6600";
        document.getElementById('profile-overlay').style.display = 'flex';
    }

    function saveProfile() {
        localStorage.setItem('U_NAME', document.getElementById('edit-name').value.trim());
        localStorage.setItem('U_AVATAR', document.getElementById('edit-avatar').value.trim());
        localStorage.setItem('U_BG_COLOR', document.getElementById('edit-bg-color').value);
        document.getElementById('profile-overlay').style.display = 'none';
        loadProfile();
    }

    function incrementUsage() {
    const today = new Date().toDateString();
    const stored = JSON.parse(localStorage.getItem('USAGE_STAT') || '{}');
    const count = (stored.date === today ? stored.count : 0) + 1;
    localStorage.setItem('USAGE_STAT', JSON.stringify({date: today, count: count}));
    
    // é€™è£¡æœƒè¨˜éŒ„ç¸½æ¬¡æ•¸ï¼Œç”¨ä¾†ç®—å¸³å–®
    let total = parseInt(localStorage.getItem('TOTAL_SEARCHES') || '0') + 1;
    localStorage.setItem('TOTAL_SEARCHES', total.toString());
    
    updateUsageDisplay(); 
    loadProfile(); 
    updateApiBillingDisplay(); // <--- å°±æ˜¯åŠ åœ¨é€™ä¸€è¡Œï¼Œè®“æœå°‹å®Œç«‹åˆ»æ›´æ–°å¸³å–®å„€è¡¨æ¿
}

    function checkTransAvailability() {
        const transport = document.getElementById('transport').value;
        const mrtSec = document.getElementById('mrt-section');
        if (transport === 'none' || isNearbyMode) { mrtSec.style.display = 'none'; return; }
        mrtSec.style.display = 'block';
    }

    function toggleApiGuide() {
        const box = document.getElementById('api-guide-box');
        box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    }

 

        // --- ç³»çµ±è¨­å®šåŠŸèƒ½ ---

function openSettings() {
    // é è¼‰ç›®å‰è¨­å®šçš„å€¼
    const savedCount = localStorage.getItem('EXPLORER_CARD_COUNT') || "10";
    document.getElementById('setting-card-count').value = savedCount;
    
    toggleSideMenu(false); // é—œé–‰å´é‚Šæ¬„
    setTimeout(() => {
        document.getElementById('settings-overlay').style.display = 'flex';
    }, 300);
}

function saveSettings() {
    const cardCount = document.getElementById('setting-card-count').value;
    localStorage.setItem('EXPLORER_CARD_COUNT', cardCount);
    
    document.getElementById('settings-overlay').style.display = 'none';
    alert("è¨­å®šå·²å„²å­˜ï¼ä¸‹æ¬¡æœå°‹å°‡å¥—ç”¨æ–°åƒæ•¸ã€‚");
}

        function resetUI() {
    document.getElementById('swiper-overlay').style.display = 'none';
    document.getElementById('no-match-modal').style.display = 'none';
    document.getElementById('history-overlay').style.display = 'none';
    document.getElementById('profile-overlay').style.display = 'none';
    document.getElementById('settings-overlay').style.display = 'none'; // æ–°å¢é€™è¡Œ
    document.getElementById('main-ui').classList.remove('blur-mode');
    keptRestaurants = [];
    isFinalOne = false;
}

        let currentEditingShopId = null;

// 1. é–‹å•Ÿç­†è¨˜ç·¨è¼¯å™¨
function openNoteEditor(placeId) {
    let favs = JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]');
    const shop = favs.find(i => i.place_id === placeId);
    if (!shop) return;

    currentEditingShopId = placeId;
    document.getElementById('note-shop-name').innerText = shop.name;
    document.getElementById('note-text-area').value = shop.userNote || "";
    
    const preview = document.getElementById('note-img-preview');
    const hint = document.getElementById('note-upload-hint');
    if (shop.userImage) {
        preview.src = shop.userImage;
        preview.style.display = "block";
        hint.style.display = "none";
    } else {
        preview.style.display = "none";
        hint.style.display = "block";
    }
    
    document.getElementById('note-overlay').style.display = 'flex';
}

// 2. è™•ç†åœ–ç‰‡ä¸Šå‚³ä¸¦å£“ç¸® (é—œéµï¼šé˜²æ­¢è¶…é LocalStorage é™åˆ¶)
function handleNoteImage(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // å»ºç«‹ç•«å¸ƒä¾†å£“ç¸®åœ–ç‰‡
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 400; // ç¸®å°å°ºå¯¸
            let width = img.width;
            let height = img.height;

            if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // è½‰æ›ç‚ºä½è³ªé‡çš„ base64 å­˜å…¥
            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById('note-img-preview').src = compressedBase64;
            document.getElementById('note-img-preview').style.display = "block";
            document.getElementById('note-upload-hint').style.display = "none";
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// 3. å„²å­˜ç­†è¨˜åˆ°è³‡æ–™åº«
function saveShopNote() {
    let favs = JSON.parse(localStorage.getItem('TASTE_FAVORITES') || '[]');
    const idx = favs.findIndex(i => i.place_id === currentEditingShopId);
    
    if (idx !== -1) {
        favs[idx].userNote = document.getElementById('note-text-area').value;
        const previewSrc = document.getElementById('note-img-preview').src;
        // å¦‚æœé è¦½åœ–æ˜¯ Base64 æ ¼å¼æ‰å­˜å…¥
        favs[idx].userImage = previewSrc.startsWith('data:image') ? previewSrc : null;
        
        localStorage.setItem('TASTE_FAVORITES', JSON.stringify(favs));
        document.getElementById('note-overlay').style.display = 'none';
        renderHistoryList('fav'); // åˆ·æ–°æ¸…å–®é¡¯ç¤º ğŸ“ åœ–ç¤º
        alert("å¿ƒå¾—å·²æ”¶è—ï¼");
    }
}

let listTouchStart = 0;
let listTouchCurrent = 0;
let activeSwipeId = null;

function handleListTouchStart(e, id) {
    // å¦‚æœæœ‰å…¶ä»–é …é–‹è‘—ï¼Œå…ˆé—œæ‰
    if (activeSwipeId && activeSwipeId !== id) {
        closeSwipe(activeSwipeId);
    }
    listTouchStart = e.touches[0].clientX;
    const content = document.getElementById(`content-${id}`);
    content.style.transition = "none";
}

function handleListTouchMove(e, id) {
    listTouchCurrent = e.touches[0].clientX;
    let diff = listTouchCurrent - listTouchStart;
    const content = document.getElementById(`content-${id}`);

    // åªå…è¨±å‘å·¦æ»‘å‹•ï¼Œä¸”æœ€å¤§æ»‘å‹•è·é›¢ 80px
    if (diff < 0 && diff > -120) {
        content.style.transform = `translateX(${diff}px)`;
    }
}

function handleListTouchEnd(e, id) {
    const content = document.getElementById(`content-${id}`);
    content.style.transition = "transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)";
    
    let diff = listTouchCurrent - listTouchStart;

    if (diff < -50) {
        // æ»‘å‹•è¶…é 50pxï¼Œå›ºå®šåœ¨ã€Œåˆªé™¤æŒ‰éˆ•ã€é–‹å•Ÿç‹€æ…‹
        content.style.transform = `translateX(-80px)`;
        activeSwipeId = id;
    } else {
        // æ»‘å‹•ä¸è¶³ï¼Œå½ˆå›
        content.style.transform = `translateX(0px)`;
        activeSwipeId = null;
    }
    listTouchStart = 0;
    listTouchCurrent = 0;
}

function closeSwipe(id) {
    const content = document.getElementById(`content-${id}`);
    if (content) {
        content.style.transform = `translateX(0px)`;
    }
}

function updateApiBillingDisplay() {
    // Google Places Text Search (New) æ¯æ¬¡è«‹æ±‚ç´„ $0.02 USD
    const COST_PER_SEARCH = 0.02;
    const MONTHLY_FREE_CREDIT = 200.00;

    // å¾æœ¬åœ°ç´€éŒ„ç²å–æœ¬æœˆç¸½æœå°‹æ¬¡æ•¸ (æˆ‘å€‘ä¹‹å‰å·²ç¶“æœ‰ TOTAL_SEARCHES)
    const totalSearches = parseInt(localStorage.getItem('TOTAL_SEARCHES') || '0');
    
    // è¨ˆç®—æ¶ˆè€—
    const estimatedCost = totalSearches * COST_PER_SEARCH;
    const remainingCredit = Math.max(0, MONTHLY_FREE_CREDIT - estimatedCost);
    const usePercent = (estimatedCost / MONTHLY_FREE_CREDIT) * 100;

    // æ›´æ–° UI
    document.getElementById('est-cost').innerText = `$${estimatedCost.toFixed(2)}`;
    document.getElementById('free-remain').innerText = `$${remainingCredit.toFixed(2)}`;
    
    const bar = document.getElementById('api-usage-bar');
    bar.style.width = `${Math.min(100, usePercent)}%`;

    // æ ¹æ“šä½¿ç”¨é‡æ”¹è®Šé¡è‰²è­¦å‘Š
    const percentLabel = document.getElementById('billing-percent');
    if (usePercent > 80) {
        bar.style.background = '#e74c3c';
        percentLabel.innerText = "é¡åº¦å°‡ç›¡";
        percentLabel.style.color = "#e74c3c";
    } else if (usePercent > 50) {
        bar.style.background = '#f1c40f';
        percentLabel.innerText = "ç”¨é‡ä¸­ç­‰";
        percentLabel.style.color = "#f1c40f";
    }
}
        
    </script> 

    <div id="settings-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(15px); z-index:12000; align-items:center; justify-content:center; padding:20px;">
    <div class="api-card" style="text-align:center;">
        <h2 style="color:#fff; margin-bottom:20px;">âš™ï¸ ç³»çµ±åƒæ•¸è¨­å®š</h2>
        
        <div style="margin-bottom:25px; text-align: left;">
            <label style="color:#aaa; font-size: 0.85rem; display: block; margin-bottom: 10px;">å–®æ¬¡æ¢ç´¢å»ºè­°åº—å®¶æ•¸ï¼š</label>
            <div class="input-box" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); height: 45px;">
                <select id="setting-card-count" style="color: white; width: 100%; border: none; background: transparent; outline: none;">
                    <option value="6">ç²¾é¸ 6 å®¶ (æœ€çœæµé‡)</option>
                    <option value="10" selected>æ¨™æº– 10 å®¶ (å»ºè­°)</option>
                    <option value="15">è©³ç›¡ 15 å®¶</option>
                    <option value="20">è±å¯Œ 20 å®¶ (è€—è²»è¼ƒå¤šé¡åº¦)</option>
                </select>
            </div>
            <p style="color: #666; font-size: 0.7rem; margin-top: 8px;">* æ•¸é‡æ„ˆå¤šï¼ŒAI é‘‘å®šèˆ‡åˆ†ææ‰€éœ€æ™‚é–“æ„ˆé•·ã€‚</p>
        </div>

        <button class="api-save-btn" onclick="saveSettings()">å„²å­˜ç³»çµ±è¨­å®š</button>
        <button onclick="document.getElementById('settings-overlay').style.display='none'" style="background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">âœ• å–æ¶ˆè¿”å›</button>
    </div>
</div>

    <div id="history-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(25px); -webkit-backdrop-filter:blur(25px); z-index:9000; padding:30px 20px; flex-direction:column; color:white;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="history-title" style="color:var(--primary-orange); margin:0; font-size:1.5rem;">ğŸ•’ æ¢ç´¢æ­·å²</h2>
            <button onclick="toggleHistory(false)" style="background:none; border:none; color:#fff; font-size:1.8rem; cursor:pointer;">âœ•</button>
        </div>
        <div id="history-list" style="overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:15px; padding-bottom:20px;"></div>
        <button id="clear-all-btn" onclick="clearAllHistory()" style="width:100%; padding:15px; background:rgba(255,102,0,0.1); border:1px solid var(--primary-orange); color:var(--primary-orange); border-radius:12px; font-weight:bold; cursor:pointer;">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
    </div>
    <!-- ä½¿ç”¨è€…å€‹äººè³‡æ–™è¨­å®šå½ˆçª— -->
<div id="profile-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(15px); z-index:11000; align-items:center; justify-content:center; padding:20px;">
    <div class="api-card" style="text-align:center;">
        <h2 style="color:#fff; margin-bottom:20px;">ğŸ‘¤ ç·¨è¼¯å€‹äººè³‡æ–™</h2>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;">
            <div style="flex: 1;">
                <label style="display:block; margin-bottom:8px; color:#aaa; font-size: 0.8rem;">é ­åƒ Emoji</label>
                <input type="text" id="edit-avatar" class="api-input" style="font-size:1.5rem; padding: 10px;" maxlength="2" placeholder="ğŸ‘¤">
            </div>
            <div style="flex: 1;">
                <label style="display:block; margin-bottom:8px; color:#aaa; font-size: 0.8rem;">èƒŒæ™¯é¡è‰²</label>
                <input type="color" id="edit-bg-color" style="width: 100%; height: 45px; border: none; background: transparent; cursor: pointer; padding:0;">
            </div>
        </div>

        <div style="margin-bottom:25px;">
            <label style="display:block; margin-bottom:10px; color:#aaa;">ä½ çš„ç¨±å‘¼</label>
            <input type="text" id="edit-name" class="api-input" placeholder="è¼¸å…¥åå­—...">
        </div>

        <button class="api-save-btn" onclick="saveProfile()">å„²å­˜å€‹äººè¨­å®š</button>
        <button onclick="document.getElementById('profile-overlay').style.display='none'" style="background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">âœ• å–æ¶ˆè¿”å›</button>
    </div>
</div>
    <div id="note-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(15px); z-index:15000; align-items:center; justify-content:center; padding:20px;">
    <div class="api-card" style="max-width: 400px;">
        <h2 id="note-shop-name" style="color:#fff; margin-bottom:10px;">åº—å</h2>
        <div id="note-upload-area" onclick="document.getElementById('note-file-input').click()" style="width:100%; height:150px; background:rgba(255,255,255,0.05); border:2px dashed rgba(255,255,255,0.2); border-radius:15px; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;">
            <img id="note-img-preview" style="width:100%; height:100%; object-fit:cover; display:none;">
            <span id="note-upload-hint" style="color:#666;">ğŸ“¸ é»æ“Šä¸Šå‚³é£Ÿç‰©ç…§ç‰‡</span>
            <input type="file" id="note-file-input" hidden accept="image/*" onchange="handleNoteImage(this)">
        </div>
        <textarea id="note-text-area" class="api-input" style="height:100px; margin-top:15px; text-align:left;" placeholder="å¯«ä¸‹ä½ çš„ç”¨é¤ç­†è¨˜..."></textarea>
        <button class="api-save-btn" style="margin-top:15px;" onclick="saveShopNote()">å„²å­˜å¿ƒå¾—</button>
        <button onclick="document.getElementById('note-overlay').style.display='none'" style="background:none; border:none; color:#555; margin-top:15px; cursor:pointer; width:100%;">âœ• å–æ¶ˆ</button>
    </div>
</body>
</html>
